# Drx.Sdk.Network.V2.Web 上传与下载功能说明

---

## 目录
- [概述](#概述)
- [上传功能](#上传功能)
  - [流式上传接口](#流式上传接口)
  - [客户端上传示例](#客户端上传示例)
- [下载功能](#下载功能)
  - [流式下载接口](#流式下载接口)
  - [客户端下载示例](#客户端下载示例)
- [常见问题与注意事项](#常见问题与注意事项)

---

## 概述
本模块提供高性能的 HTTP 上传与下载能力，支持大文件流式传输、进度回调、断点续传（Range）、多种路由注册方式，适用于各类 .NET 服务端与客户端场景。

---

## 上传功能

### 流式上传接口
服务器端通过 `HttpServer.AddStreamUploadRoute` 或 `AddRawRoute` 注册流式上传路由。

- 推荐接口：
```csharp
server.AddStreamUploadRoute("/api/upload", async (req) => {
    // req.UploadFile.Stream 即为上传的文件流
    var result = HttpServer.SaveUploadFile(req, savePath: "C:/uploads", fileName: "myfile.dat");
    return result;
});
```
- 也可用原始路由：
```csharp
server.AddRawRoute("/api/uploadraw", async (ctx) => {
    // ctx.Request.InputStream 为原始流
    // ...自定义处理...
});
```

#### 处理方法说明
- 推荐使用 `HttpRequest.UploadFile.Stream` 读取上传内容。
- 可通过 `HttpServer.SaveUploadFile` 快速保存上传文件。
- 支持自定义保存路径与文件名。

### 客户端上传示例

- 上传本地文件：
```csharp
using var client = new HttpClient();
await client.UploadFileAsync(
    url: "http://server/api/upload",
    filePath: "C:/local/file.dat",
    fieldName: "file",
    progress: new Progress<long>(bytes => Console.WriteLine($"已上传: {bytes}字节")),
    cancellationToken: CancellationToken.None
);
```
- 上传流：
```csharp
using var fs = File.OpenRead("C:/local/file.dat");
await client.UploadFileAsync(
    url: "http://server/api/upload",
    fileStream: fs,
    fileName: "file.dat",
    fieldName: "file"
);
```
- 上传并附加元数据：
```csharp
await client.UploadFileWithMetadataAsync(
    url: "http://server/api/upload",
    filePath: "C:/local/file.dat",
    metadata: new { user = "张三", type = "image" }
);
```

---

## 下载功能

### 流式下载接口
服务器端可通过 `AddFileRoute` 或自定义路由实现文件下载。

- 文件路由自动映射：
```csharp
server.AddFileRoute("/download/", "C:/wwwroot");
// 访问 /download/xxx.dat 即下载 C:/wwwroot/xxx.dat
```
- 自定义下载接口：
```csharp
server.AddRoute(HttpMethod.Get, "/api/download/{id}", async (req) => {
    string filePath = ...; // 根据 id 查找文件
    return HttpServer.CreateFileResponse(filePath);
});
```

#### 处理方法说明
- 推荐使用 `HttpServer.CreateFileResponse` 生成下载响应。
- 自动设置 Content-Type、Content-Disposition，支持安全文件名过滤。
- 支持 Range 断点续传。

### 客户端下载示例

- 下载到本地文件：
```csharp
using var client = new HttpClient();
await client.DownloadFileAsync(
    url: "http://server/download/file.dat",
    destPath: "C:/local/file.dat",
    progress: new Progress<long>(bytes => Console.WriteLine($"已下载: {bytes}字节")),
    cancellationToken: CancellationToken.None
);
```
- 下载到自定义流：
```csharp
using var fs = File.Create("C:/local/file.dat");
await client.DownloadToStreamAsync(
    url: "http://server/download/file.dat",
    destination: fs
);
```

---

## 常见问题与注意事项
- 上传/下载均支持进度回调与取消。
- 文件路由支持大文件高效传输，自动处理 Range 请求。
- 上传接口建议限制最大文件大小，防止恶意占用资源。
- 下载接口建议校验文件存在性与权限。
- 所有接口均支持异步调用。
- 路由注册时路径建议以 `/` 开头。

---

## 参考
- 主要类：`HttpServer`, `HttpClient`
- 相关方法：`AddStreamUploadRoute`, `AddFileRoute`, `UploadFileAsync`, `DownloadFileAsync`, `CreateFileResponse`, `SaveUploadFile`
- 详细 API 请参考源码注释。

---

> 本文档最后更新：2025-11-04
