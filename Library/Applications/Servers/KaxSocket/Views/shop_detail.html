<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å•†å“è¯¦æƒ… - KaxHub å•†åŸ</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <link href="/global.css" rel="stylesheet">
    <script src="/global.js"></script>
    <style>
        /* ä¸»é¢˜å˜é‡ */
        :root {
            --topbar-height: 64px;
            --accent: #3b82f6;
            --bg: #0f0f0f;
            --card-bg: rgba(255, 255, 255, 0.02);
            --card-border: rgba(255, 255, 255, 0.05);
            --text-primary: #ffffff;
            --text-secondary: rgba(255, 255, 255, 0.7);
            --text-muted: rgba(255, 255, 255, 0.5);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Poppins', sans-serif;
            background: var(--bg);
            color: var(--text-primary);
            -webkit-font-smoothing: antialiased;
        }

        .detail-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 40px 20px;
        }

        /* é¢åŒ…å±‘å¯¼èˆª */
        .breadcrumb {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 32px;
            font-size: 0.95rem;
        }

        .breadcrumb a {
            color: var(--accent);
            text-decoration: none;
            transition: opacity 0.2s ease;
        }

        .breadcrumb a:hover {
            opacity: 0.8;
        }

        .breadcrumb span {
            color: var(--text-muted);
            margin: 0 4px;
        }

        .breadcrumb .current {
            color: var(--text-secondary);
        }

        /* ä¸»å†…å®¹åŒºåŸŸ - ä¸¤æ å¸ƒå±€ */
        .detail-main {
            display: grid;
            grid-template-columns: 1fr 380px;
            gap: 32px;
            margin-bottom: 40px;
        }

        /* å·¦ä¾§ï¼šäº§å“å›¾ç‰‡ä¸è¯¦ç»†ä¿¡æ¯ */
        .detail-left {
            display: flex;
            flex-direction: column;
            gap: 24px;
        }

        .product-gallery {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .product-main-image {
            width: 100%;
            height: 400px;
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.1) 0%, rgba(139, 92, 246, 0.1) 100%);
            border: 1px solid var(--card-border);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 120px;
            overflow: hidden;
        }

        .product-thumbnails {
            display: flex;
            gap: 8px;
        }

        .product-thumbnail {
            width: 80px;
            height: 80px;
            background: rgba(255, 255, 255, 0.02);
            border: 1px solid var(--card-border);
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 32px;
        }

        .product-thumbnail:hover,
        .product-thumbnail.active {
            border-color: var(--accent);
            background: rgba(59, 130, 246, 0.1);
        }

        /* äº§å“åŸºæœ¬ä¿¡æ¯å¡ç‰‡ */
        .product-info-card {
            background: var(--card-bg);
            border: 1px solid var(--card-border);
            border-radius: 8px;
            padding: 24px;
        }

        .product-name {
            font-size: 1.8rem;
            font-weight: 700;
            margin-bottom: 12px;
            color: var(--text-primary);
        }

        .product-rating {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 16px;
            padding-bottom: 16px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }

        .rating-stars {
            display: flex;
            gap: 2px;
            color: #fbbf24;
        }

        .rating-text {
            font-size: 0.95rem;
            color: var(--text-secondary);
        }

        .rating-count {
            font-size: 0.9rem;
            color: var(--text-muted);
            margin-left: auto;
        }

        .product-description {
            color: var(--text-secondary);
            line-height: 1.6;
            margin-bottom: 20px;
        }

        .product-meta {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 16px;
            padding: 16px 0;
            border-top: 1px solid rgba(255, 255, 255, 0.05);
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }

        .meta-item {
            text-align: center;
        }

        .meta-label {
            display: block;
            font-size: 0.85rem;
            color: var(--text-muted);
            margin-bottom: 4px;
        }

        .meta-value {
            display: block;
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--text-primary);
        }

        /* è¯¦ç»†è§„æ ¼è¡¨ */
        .specs-section {
            background: var(--card-bg);
            border: 1px solid var(--card-border);
            border-radius: 8px;
            padding: 24px;
        }

        .section-title {
            font-size: 1.1rem;
            font-weight: 700;
            margin-bottom: 16px;
            color: var(--text-primary);
        }

        .specs-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .spec-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.02);
        }

        .spec-item:last-child {
            border-bottom: none;
        }

        .spec-label {
            color: var(--text-secondary);
            font-weight: 500;
        }

        .spec-value {
            color: var(--text-primary);
            font-weight: 600;
        }

        /* å³ä¾§ï¼šè´­ä¹°é¢æ¿ */
        .detail-right {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .purchase-panel {
            background: var(--card-bg);
            border: 1px solid var(--card-border);
            border-radius: 8px;
            padding: 24px;
            position: sticky;
            top: calc(var(--topbar-height) + 20px);
        }

        .price-section {
            text-align: center;
            padding: 20px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }

        .price-current {
            font-size: 2.2rem;
            font-weight: 700;
            color: var(--accent);
            margin-bottom: 4px;
        }

        .price-original {
            font-size: 0.95rem;
            color: var(--text-muted);
            text-decoration: line-through;
            margin-bottom: 8px;
        }

        .price-badge {
            display: inline-block;
            background: rgba(59, 130, 246, 0.2);
            color: var(--accent);
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.85rem;
            font-weight: 600;
        }

        .purchase-options {
            display: flex;
            flex-direction: column;
            gap: 16px;
            padding: 20px 0;
        }

        .quantity-selector {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .quantity-label {
            color: var(--text-secondary);
            font-size: 0.95rem;
            min-width: 50px;
        }

        .quantity-control {
            display: flex;
            align-items: center;
            gap: 0;
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 4px;
            overflow: hidden;
        }

        .quantity-btn {
            width: 32px;
            height: 32px;
            border: none;
            background: transparent;
            color: var(--text-primary);
            cursor: pointer;
            transition: background 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
        }

        .quantity-btn:hover {
            background: rgba(255, 255, 255, 0.08);
        }

        .quantity-input {
            width: 50px;
            height: 32px;
            border: none;
            border-left: 1px solid rgba(255, 255, 255, 0.1);
            border-right: 1px solid rgba(255, 255, 255, 0.1);
            background: transparent;
            color: var(--text-primary);
            text-align: center;
            font-family: 'Poppins', sans-serif;
            font-size: 0.95rem;
        }

        .quantity-input::-webkit-inner-spin-button,
        .quantity-input::-webkit-outer-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }

        .purchase-actions {
            display: flex;
            flex-direction: column;
            gap: 12px;
            padding-top: 20px;
            border-top: 1px solid rgba(255, 255, 255, 0.05);
        }

        .btn-cart {
            background: var(--accent);
            color: #ffffff;
            padding: 12px 24px;
            border: none;
            border-radius: 4px;
            font-weight: 600;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .btn-cart:hover {
            background: #2563eb;
        }

        .purchase-options-second {
            display: flex;
            gap: 12px;
        }

        .btn-secondary {
            flex: 1;
            padding: 10px 16px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            background: transparent;
            color: var(--text-primary);
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            font-size: 0.95rem;
        }

        .btn-secondary:hover {
            border-color: var(--accent);
            background: rgba(59, 130, 246, 0.1);
        }

        .stock-info {
            background: rgba(34, 197, 94, 0.1);
            border: 1px solid rgba(34, 197, 94, 0.3);
            color: #86efac;
            padding: 12px;
            border-radius: 4px;
            font-size: 0.95rem;
            text-align: center;
            margin-top: 12px;
        }

        .stock-info.low {
            background: rgba(239, 68, 68, 0.1);
            border-color: rgba(239, 68, 68, 0.3);
            color: #fca5a5;
        }

        /* ç›¸å…³äº§å“ */
        .related-products {
            margin-top: 60px;
            padding-top: 40px;
            border-top: 1px solid rgba(255, 255, 255, 0.05);
        }

        .related-title {
            font-size: 1.5rem;
            font-weight: 700;
            margin-bottom: 24px;
            color: var(--text-primary);
        }

        .related-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 20px;
        }

        .related-card {
            background: var(--card-bg);
            border: 1px solid var(--card-border);
            border-radius: 8px;
            overflow: hidden;
            transition: all 0.2s ease;
            cursor: pointer;
        }

        .related-card:hover {
            background: rgba(255, 255, 255, 0.04);
            border-color: rgba(255, 255, 255, 0.08);
            transform: translateY(-2px);
        }

        .related-image {
            width: 100%;
            height: 140px;
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.1) 0%, rgba(139, 92, 246, 0.1) 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 60px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.04);
        }

        .related-content {
            padding: 12px;
        }

        .related-name {
            font-size: 0.95rem;
            font-weight: 600;
            margin-bottom: 8px;
            color: var(--text-primary);
            line-height: 1.3;
        }

        .related-price {
            font-size: 1.1rem;
            font-weight: 700;
            color: var(--accent);
        }

        /* å“åº”å¼è®¾è®¡ */
        @media (max-width: 768px) {
            .detail-container {
                padding: 24px 16px;
            }

            .detail-main {
                grid-template-columns: 1fr;
                gap: 24px;
            }

            .purchase-panel {
                position: static;
            }

            .product-main-image {
                height: 300px;
                font-size: 80px;
            }

            .product-name {
                font-size: 1.5rem;
            }

            .price-current {
                font-size: 1.8rem;
            }

            .product-meta {
                grid-template-columns: 1fr;
            }

            .related-grid {
                grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
                gap: 16px;
            }

            .breadcrumb {
                font-size: 0.85rem;
            }
        }

        @media (max-width: 480px) {
            .detail-container {
                padding: 16px 12px;
            }

            .product-name {
                font-size: 1.3rem;
            }

            .price-current {
                font-size: 1.6rem;
            }

            .product-main-image {
                height: 240px;
                font-size: 60px;
            }

            .purchase-options-second {
                flex-direction: column;
            }

            .btn-secondary {
                width: 100%;
            }
        }
    </style>
</head>

<body class="has-global-topbar">
    <!-- é¢åŒ…å±‘å¯¼èˆª -->
    <div class="detail-container">
        <div class="breadcrumb">
            <a href="/shop">å•†åŸ</a>
            <span>/</span>
            <span class="current" id="breadcrumbCategory">æ¨¡ç»„</span>
        </div>
    </div>

    <!-- ä¸»å†…å®¹åŒºåŸŸ -->
    <div class="detail-container">
        <div class="detail-main">
            <!-- å·¦ä¾§ï¼šäº§å“å›¾ç‰‡ä¸è¯¦ç»†ä¿¡æ¯ -->
            <div class="detail-left">
                <!-- äº§å“å›¾åº“ -->
                <div class="product-gallery">
                    <div class="product-main-image" id="mainImage">ğŸ®</div>
                    <div class="product-thumbnails" id="thumbnailContainer">
                        <div class="product-thumbnail active">ğŸ®</div>
                    </div>
                </div>

                <!-- äº§å“åŸºæœ¬ä¿¡æ¯ -->
                <div class="product-info-card">
                    <h1 class="product-name" id="productName">åŠ è½½ä¸­...</h1>

                    <div class="product-rating">
                        <div class="rating-stars" id="ratingStars">â­â­â­â­â­</div>
                        <span class="rating-text" id="ratingScore">5.0</span>
                        <span class="rating-count" id="ratingCount">(128 æ¡è¯„ä»·)</span>
                    </div>

                    <p class="product-description" id="productDescription">
                        åŠ è½½ä¸­...
                    </p>

                    <div class="product-meta">
                        <div class="meta-item">
                            <span class="meta-label">ç‰ˆæœ¬</span>
                            <span class="meta-value" id="productVersion">1.0.0</span>
                        </div>
                        <div class="meta-item">
                            <span class="meta-label">å…¼å®¹æ€§</span>
                            <span class="meta-value" id="productCompatibility">100%</span>
                        </div>
                        <div class="meta-item">
                            <span class="meta-label">ä¸‹è½½é‡</span>
                            <span class="meta-value" id="productDownloads">1.2K</span>
                        </div>
                    </div>
                </div>

                <!-- è¯¦ç»†è§„æ ¼ -->
                <div class="specs-section">
                    <h2 class="section-title">è¯¦ç»†è§„æ ¼</h2>
                    <div class="specs-list" id="specsList">
                        <div class="spec-item">
                            <span class="spec-label">æ–‡ä»¶å¤§å°</span>
                            <span class="spec-value">256 MB</span>
                        </div>
                        <div class="spec-item">
                            <span class="spec-label">ä¸Šä¼ æ—¶é—´</span>
                            <span class="spec-value">2026-02-20</span>
                        </div>
                        <div class="spec-item">
                            <span class="spec-label">ä½œè€…</span>
                            <span class="spec-value">å¼€å‘è€…</span>
                        </div>
                        <div class="spec-item">
                            <span class="spec-label">è®¸å¯è¯</span>
                            <span class="spec-value">MIT</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- å³ä¾§ï¼šè´­ä¹°é¢æ¿ -->
            <div class="detail-right">
                <div class="purchase-panel">
                    <!-- ä»·æ ¼ -->
                    <div class="price-section">
                        <div class="price-original" id="priceOriginal">Â¥99.99</div>
                        <div class="price-current" id="priceCurrent">Â¥79.99</div>
                        <span class="price-badge" id="priceBadge">20% OFF</span>
                    </div>

                    <!-- è´­ä¹°é€‰é¡¹ -->
                    <div class="purchase-options">
                        <div class="quantity-selector">
                            <label class="quantity-label">æ•°é‡</label>
                            <div class="quantity-control">
                                <button class="quantity-btn" id="quantityMinus">âˆ’</button>
                                <!-- ä½¿ç”¨è‡ªå®šä¹‰ input-box ç»„ä»¶ï¼ˆé™çº§å›é€€ä¸ºåŸç”Ÿ input ä¿æŒå…¼å®¹æ€§ï¼‰ -->
                                <input-box id="quantityInputBox" label="æ•°é‡" placeholder="1"></input-box>
                                <!-- åŸç”Ÿ input ä½œä¸ºå›é€€ï¼ˆè„šæœ¬ä¼šä¼˜å…ˆæŸ¥æ‰¾å†…éƒ¨ inputï¼‰ -->
                                <input type="number" class="quantity-input" id="quantityInput" value="1" min="1"
                                    max="999" style="display:none;" aria-hidden="true">
                                <button class="quantity-btn" id="quantityPlus">+</button>
                            </div>
                        </div>

                        <div class="stock-info" id="stockInfo">
                            âœ“ åº“å­˜å……è¶³ï¼Œç«‹å³å‘è´§
                        </div>
                    </div>

                    <!-- æ“ä½œæŒ‰é’® -->
                    <div class="purchase-actions">
                        <button class="btn-cart" id="addToCartBtn">
                            <span class="material-icons">shopping_cart</span>
                            åŠ å…¥è´­ç‰©è½¦
                        </button>

                        <div class="purchase-options-second">
                            <button class="btn-secondary" id="favBtn" title="æ”¶è—">
                                <span class="material-icons">favorite_border</span>
                                <span>æ”¶è—</span>
                            </button>
                            <button class="btn-secondary" id="shareBtn" title="åˆ†äº«">
                                <span class="material-icons">share</span>
                                <span>åˆ†äº«</span>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ç›¸å…³äº§å“æ¨è -->
        <div class="related-products">
            <h2 class="related-title">çƒ­é—¨æ¨è</h2>
            <div class="related-grid" id="relatedProductsGrid">
                <div class="related-card" onclick="goToShopDetail(1)">
                    <div class="related-image">ğŸ®</div>
                    <div class="related-content">
                        <div class="related-name">çƒ­é—¨æ¨¡ç»„ 1</div>
                        <div class="related-price">Â¥59.99</div>
                    </div>
                </div>
                <div class="related-card" onclick="goToShopDetail(2)">
                    <div class="related-image">ğŸ®</div>
                    <div class="related-content">
                        <div class="related-name">çƒ­é—¨æ¨¡ç»„ 2</div>
                        <div class="related-price">Â¥49.99</div>
                    </div>
                </div>
                <div class="related-card" onclick="goToShopDetail(3)">
                    <div class="related-image">ğŸ®</div>
                    <div class="related-content">
                        <div class="related-name">çƒ­é—¨æ¨¡ç»„ 3</div>
                        <div class="related-price">Â¥69.99</div>
                    </div>
                </div>
                <div class="related-card" onclick="goToShopDetail(4)">
                    <div class="related-image">ğŸ®</div>
                    <div class="related-content">
                        <div class="related-name">çƒ­é—¨æ¨¡ç»„ 4</div>
                        <div class="related-price">Â¥79.99</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>

        // æ—¶é—´æˆ³è½¬æ—¥æœŸæ ¼å¼åŒ–
        function formatDate(ts) {
            if (!ts || ts === '--') return '--';
            // æ”¯æŒç§’/æ¯«ç§’
            const ms = ts > 9999999999 ? ts : ts * 1000;
            const date = new Date(ms);
            if (isNaN(date.getTime())) return '--';
            return date.toLocaleDateString('zh-CN', { year: 'numeric', month: '2-digit', day: '2-digit' });
        }

        // æœªç™»å½•ç›´æ¥è·³è½¬ç™»å½•é¡µ
        const token = localStorage.getItem('kax_login_token');
        if (!token) {
            window.location.href = '/login';
        }

        // ä» URL å‚æ•°æˆ–è·¯å¾„ä¸­è·å–äº§å“ IDï¼ˆå…¼å®¹ /asset/detail?id=1 ä¸ /asset/detail/1ï¼‰
        function getProductIdFromUrl() {
            const urlParams = new URLSearchParams(window.location.search);
            const qid = urlParams.get('id');
            if (qid && /^\d+$/.test(qid)) return qid;

            const parts = window.location.pathname.split('/').filter(Boolean);
            const last = parts.length ? parts[parts.length - 1] : '';
            if (/^\d+$/.test(last)) return last;

            return '1';
        }

        const productId = parseInt(getProductIdFromUrl(), 10) || 1;

        // æ¨¡æ‹Ÿäº§å“æ•°æ®ï¼ˆä½œä¸ºå›é€€ï¼Œå®é™…ä¼˜å…ˆä»åç«¯ API è·å–ï¼‰
        const productData = {
            1: {
                id: 1,
                name: 'é«˜çº§æ¸¸æˆæ¨¡ç»„åŒ…',
                description: 'ä¸€ä¸ªåŠŸèƒ½å®Œæ•´çš„æ¸¸æˆæ¨¡ç»„ï¼ŒåŒ…å«å¤šé¡¹é«˜çº§åŠŸèƒ½å’Œä¼˜åŒ–ã€‚æä¾›å®Œæ•´çš„æ–‡æ¡£å’ŒæŠ€æœ¯æ”¯æŒã€‚',
                price: 79.99,
                originalPrice: 99.99,
                category: 'æ¨¡ç»„',
                rating: 4.8,
                reviews: 128,
                version: '2.1.0',
                compatibility: '98%',
                downloads: 1243,
                fileSize: '256 MB',
                uploadDate: '2026-02-20',
                author: 'å¼€å‘è€…å›¢é˜Ÿ',
                license: 'MIT',
                stock: 150,
            },
            2: {
                id: 2,
                name: 'è½»é‡åŒ–ä¼˜åŒ–æ¨¡ç»„',
                description: 'ä¸“æ³¨äºæ€§èƒ½ä¼˜åŒ–çš„è½»é‡çº§æ¨¡ç»„ï¼Œä¸ºä½é…ç½®è®¾å¤‡æä¾›æœ€ä½³ä½“éªŒã€‚',
                price: 49.99,
                originalPrice: 69.99,
                category: 'æ¨¡ç»„',
                rating: 4.6,
                reviews: 89,
                version: '1.8.5',
                compatibility: '95%',
                downloads: 856,
                fileSize: '128 MB',
                uploadDate: '2026-02-18',
                author: 'ä¼˜åŒ–å›¢é˜Ÿ',
                license: 'MIT',
                stock: 200,
            }
        };

        // åˆå§‹åŒ–é¡µé¢ï¼ˆä¼˜å…ˆä»åç«¯è·å–ï¼‰
        async function initPage() {
            let product = productData[productId] || productData[1];

            try {
                const resp = await fetch(`/api/asset/detail/${productId}`, { credentials: 'same-origin' });
                if (resp.ok) {
                    const json = await resp.json();
                    const asset = (json && typeof json === 'object') ? (json.data || json) : null;
                    if (asset) {
                        // Helper: normalize price units (backend may return integer cents)
                        const toNumber = v => (v === null || v === undefined) ? null : (typeof v === 'number' ? v : (isNaN(Number(v)) ? null : Number(v)));
                        const normalizeCurrency = v => {
                            const n = toNumber(v);
                            if (n === null) return null;
                            // å¦‚æœå€¼çœ‹èµ·æ¥åƒä»¥åˆ†ä¸ºå•ä½ï¼ˆ>=1000 æˆ– ä¸¤è€…å‡ä¸ºæ•´æ•°ä¸”è¾ƒå¤§ï¼‰ï¼Œé™¤ä»¥100
                            if (n >= 1000) return n / 100.0;
                            return n;
                        };

                        const rawPrice = toNumber(asset.price ?? asset.priceCents ?? asset.price_in_cents);
                        const rawOriginal = toNumber(asset.originalPrice ?? asset.priceOriginal ?? asset.original_price);
                        const rawSale = toNumber(asset.salePrice ?? asset.sale_price);

                        const price = normalizeCurrency(rawPrice);
                        const originalPrice = normalizeCurrency(rawOriginal);
                        const salePrice = rawSale != null ? normalizeCurrency(rawSale) : null;

                        // fileSize: prefer human-readable if provided, otherwise convert bytes number to readable
                        const rawFileSize = asset.fileSize ?? asset.size ?? null;
                        const fileSizeStr = (() => {
                            if (rawFileSize == null) return '--';
                            if (typeof rawFileSize === 'string') return rawFileSize;
                            const n = Number(rawFileSize);
                            if (isNaN(n)) return '--';
                            const units = ['B','KB','MB','GB','TB'];
                            let idx = 0; let val = n;
                            while (val >= 1024 && idx < units.length-1) { val /= 1024; idx++; }
                            return (idx === 0 ? val.toFixed(0) : val.toFixed(2)) + ' ' + units[idx];
                        })();

                        product = {
                            id: asset.id ?? productId,
                            name: asset.name ?? asset.title ?? '--',
                            description: asset.description ?? '--',
                            price: price,
                            originalPrice: price,
                            salePrice: salePrice,
                            category: asset.category ?? asset.type ?? '--',
                            rating: (asset.rating !== undefined && asset.rating !== null) ? Number(asset.rating) : null,
                            reviews: asset.reviews ?? asset.reviewCount ?? '--',
                            version: asset.version ?? '--',
                            compatibility: asset.compatibility ?? '--',
                            downloads: asset.downloads ?? '--',
                            fileSize: fileSizeStr,
                            uploadDate: asset.uploadDate ?? asset.createdAt ?? '--',
                            author: asset.author ?? asset.uploader ?? '--',
                            license: asset.license ?? '--',
                            stock: (asset.stock !== undefined && asset.stock !== null) ? asset.stock : '--',
                            discountRate: (asset.discountRate !== undefined && asset.discountRate !== null) ? Number(asset.discountRate) : null
                        };
                    }
                }
            } catch (e) {
                console.warn('è·å–å•†å“è¯¦æƒ…å¤±è´¥ï¼Œä½¿ç”¨æœ¬åœ°å›é€€æ•°æ®', e);
            }

            loadProductData(product);
            setupEventListeners();
            // å…¨å±€åˆå§‹åŒ–ï¼ˆå¦‚æœå­˜åœ¨è¿™äº›å‡½æ•°ï¼‰
            try { initGlobalTopbar && initGlobalTopbar(); } catch (e) {}
            try { initGlobalFooter && initGlobalFooter(); } catch (e) {}
            try { initButtonEffects && initButtonEffects(); } catch (e) {}
        }

        // åŠ è½½äº§å“æ•°æ®
        function loadProductData(product) {
            const orDash = (v) => (v === null || v === undefined) ? '--' : v;
            // æ—¥æœŸå­—æ®µæ ¼å¼åŒ–
            const showDate = (v) => {
                if (!v || v === '--') return '--';
                // æ”¯æŒå­—ç¬¦ä¸²/æ•°å­—
                if (typeof v === 'string' && /^\d{4}-\d{2}-\d{2}/.test(v)) return v;
                const n = Number(v);
                if (!isNaN(n)) return formatDate(n);
                return v;
            };
            const showCurrency = (v) => (v === null || v === undefined) ? '--' : ('Â¥' + Number(v).toFixed(2));
            const showDownloads = (v) => {
                if (v === null || v === undefined || v === '--') return '--';
                const n = Number(v);
                if (isNaN(n)) return '--';
                return n >= 1000 ? (n / 1000).toFixed(1) + 'K' : String(n);
            };

            document.getElementById('breadcrumbCategory').textContent = orDash(product.category);
            document.getElementById('productName').textContent = orDash(product.name);
            document.getElementById('productDescription').textContent = orDash(product.description);
            document.getElementById('productVersion').textContent = orDash(product.version);
            document.getElementById('productCompatibility').textContent = orDash(product.compatibility);
            document.getElementById('productDownloads').textContent = showDownloads(product.downloads);
            // æ˜¾ç¤ºä»·æ ¼ï¼šä¼˜å…ˆæ˜¾ç¤ºæŠ˜åä»·ï¼ˆåç«¯å¯èƒ½è¿”å› salePrice æˆ– discountRateï¼‰
            const displayOriginal = product.originalPrice != null ? product.originalPrice : null;
            const displayCurrent = (product.salePrice != null) ? product.salePrice : product.price;

            const priceOriginalEl = document.getElementById('priceOriginal');
            const priceCurrentEl = document.getElementById('priceCurrent');
            const priceBadgeEl = document.getElementById('priceBadge');

            priceCurrentEl.textContent = displayCurrent != null ? showCurrency(displayCurrent) : '--';

            // æ˜¯å¦æ˜¾ç¤ºåŸå§‹ä»·æ ¼ï¼šåªæœ‰åœ¨åŸä»·å­˜åœ¨ä¸”å¤§äºå½“å‰ä»·æ—¶æ‰æ˜¾ç¤º
            if (displayOriginal != null && displayCurrent != null && Number(displayOriginal) > Number(displayCurrent)) {
                priceOriginalEl.textContent = showCurrency(displayOriginal);
                priceOriginalEl.style.display = '';
            } else {
                priceOriginalEl.textContent = '';
                priceOriginalEl.style.display = 'none';
            }

            // è®¡ç®—å¹¶æ˜¾ç¤ºæŠ˜æ‰£å¾½æ ‡ï¼šåªæœ‰å­˜åœ¨æœ‰æ•ˆæŠ˜æ‰£ (>0) æ—¶æ˜¾ç¤ºï¼Œå¦åˆ™éšè—
            let discountPercent = null;
            if (product.discountRate != null) {
                discountPercent = Math.round(Number(product.discountRate) * 100);
            } else if (displayOriginal != null && displayCurrent != null && Number(displayOriginal) > 0) {
                const disc = Math.round(((Number(displayOriginal) - Number(displayCurrent)) / Number(displayOriginal)) * 100);
                if (disc > 0) discountPercent = disc;
            }

            if (discountPercent != null && discountPercent > 0) {
                priceBadgeEl.textContent = discountPercent + '% OFF';
                priceBadgeEl.style.display = '';
            } else {
                priceBadgeEl.textContent = '';
                priceBadgeEl.style.display = 'none';
            }

            // æ›´æ–°è¯„åˆ†
            const ratingEl = document.getElementById('ratingStars');
            const ratingScoreEl = document.getElementById('ratingScore');
            const ratingCountEl = document.getElementById('ratingCount');
            if (product.rating == null || isNaN(Number(product.rating))) {
                ratingEl.textContent = '--';
                ratingScoreEl.textContent = '--';
            } else {
                const ratingStars = Math.round(Number(product.rating));
                ratingEl.textContent = 'â­'.repeat(ratingStars) + 'â˜†'.repeat(5 - ratingStars);
                ratingScoreEl.textContent = Number(product.rating).toFixed(1);
            }
            ratingCountEl.textContent = '(' + (product.reviews != null ? product.reviews : '--') + ' æ¡è¯„ä»·)';

            // åº“å­˜çŠ¶æ€
            const stockInfo = document.getElementById('stockInfo');
            if (product.stock === '--' || product.stock === null || product.stock === undefined) {
                stockInfo.textContent = '--';
                stockInfo.classList.add('low');
            } else if (Number(product.stock) > 50) {
                stockInfo.textContent = 'âœ“ åº“å­˜å……è¶³ï¼Œç«‹å³å‘è´§';
                stockInfo.classList.remove('low');
            } else if (Number(product.stock) > 0) {
                stockInfo.textContent = 'âš  åº“å­˜æœ‰é™';
                stockInfo.classList.add('low');
            } else {
                stockInfo.textContent = 'âœ— æš‚æ— åº“å­˜';
                stockInfo.classList.add('low');
            }

            // æ›´è§„æ ¼
            const specsList = document.getElementById('specsList');
            specsList.innerHTML = `
                <div class="spec-item">
                    <span class="spec-label">æ–‡ä»¶å¤§å°</span>
                    <span class="spec-value">${orDash(product.fileSize)}</span>
                </div>
                <div class="spec-item">
                    <span class="spec-label">ä¸Šä¼ æ—¶é—´</span>
                    <span class="spec-value">${showDate(product.uploadDate)}</span>
                </div>
                <div class="spec-item">
                    <span class="spec-label">ä½œè€…</span>
                    <span class="spec-value">${orDash(product.author)}</span>
                </div>
                <div class="spec-item">
                    <span class="spec-label">è®¸å¯è¯</span>
                    <span class="spec-value">${orDash(product.license)}</span>
                </div>
            `;

            // å­˜å‚¨å½“å‰äº§å“æ•°æ®åˆ° window
            window.currentProduct = product;
        }

        // è®¾ç½®äº‹ä»¶ç›‘å¬å™¨
        function setupEventListeners() {
            // å…¼å®¹ï¼šä¼˜å…ˆæŸ¥æ‰¾åŸç”Ÿ inputï¼ˆå›é€€ï¼‰ï¼Œå¦åˆ™æŸ¥æ‰¾è‡ªå®šä¹‰ input-box å†…éƒ¨çš„ input
            let quantityInput = document.getElementById('quantityInput');
            const quantityBox = document.getElementById('quantityInputBox');
            if ((!quantityInput || quantityInput.style.display === 'none') && quantityBox) {
                const inner = quantityBox.querySelector && quantityBox.querySelector('input');
                if (inner) quantityInput = inner;
                else {
                    // å¦‚æœ input-box æ²¡æœ‰å†…éƒ¨ inputï¼Œåˆ›å»ºä¸€ä¸ªéšè—çš„å›é€€ input æ”¾å…¥å…¶ä¸­
                    const created = document.createElement('input');
                    created.type = 'number';
                    created.className = 'quantity-input';
                    created.id = 'quantityInput';
                    created.value = '1';
                    created.min = 1;
                    created.max = 999;
                    created.style.display = 'none';
                    created.setAttribute('aria-hidden', 'true');
                    quantityBox.appendChild(created);
                    quantityInput = created;
                }
            }

            const quantityMinus = document.getElementById('quantityMinus');
            const quantityPlus = document.getElementById('quantityPlus');
            const addToCartBtn = document.getElementById('addToCartBtn');
            const favBtn = document.getElementById('favBtn');
            const shareBtn = document.getElementById('shareBtn');

            // æ•°é‡æ§åˆ¶
            quantityMinus.addEventListener('click', () => {
                const val = parseInt(quantityInput.value) || 1;
                if (val > 1) quantityInput.value = val - 1;
            });

            quantityPlus.addEventListener('click', () => {
                const val = parseInt(quantityInput.value) || 1;
                if (val < 999) quantityInput.value = val + 1;
            });

            quantityInput.addEventListener('change', () => {
                let val = parseInt(quantityInput.value) || 1;
                if (val < 1) val = 1;
                if (val > 999) val = 999;
                quantityInput.value = val;
            });

            // åŠ å…¥è´­ç‰©è½¦ â€” ä»…æ”¯æŒåç«¯ APIï¼ˆæœªç™»å½•å·²è·³è½¬ç™»å½•é¡µï¼‰
            addToCartBtn.addEventListener('click', async (e) => {
                const quantity = parseInt(quantityInput.value) || 1;
                const product = window.currentProduct;

                // é£è¡ŒåŠ¨ç”»ä¸æ·»åŠ åŠ¨ç”»
                const cartBtn = document.getElementById('cartButton');
                if (cartBtn) {
                    const rect = addToCartBtn.getBoundingClientRect();
                    const cartRect = cartBtn.getBoundingClientRect();
                    createFlyingIcon(rect, cartRect);
                }

                try {
                    const resp = await fetch('/api/user/cart', {
                        method: 'POST',
                        headers: { 'Authorization': 'Bearer ' + token, 'Content-Type': 'application/json' },
                        body: JSON.stringify({ assetId: product.id, quantity })
                    });
                    if (resp.ok) {
                        // æ›´æ–°è¿œç«¯è´­ç‰©è½¦è®¡æ•°ï¼ˆé€šè¿‡åˆ·æ–° badgeï¼‰
                        await updateCartBadge();
                    } else {
                        console.warn('åŠ å…¥è´­ç‰©è½¦å¤±è´¥', resp.status);
                    }
                } catch (e) {
                    console.error('åŠ å…¥è´­ç‰©è½¦å‡ºé”™', e);
                }

                // æç¤ºåé¦ˆ
                addToCartBtn.textContent = 'âœ“ å·²æ·»åŠ åˆ°è´­ç‰©è½¦';
                setTimeout(() => {
                    addToCartBtn.textContent = 'åŠ å…¥è´­ç‰©è½¦';
                }, 2000);
            });

            // æ”¶è—æŒ‰é’® â€” ä½¿ç”¨åç«¯ APIï¼ˆç™»å½•ç”¨æˆ·ï¼‰ï¼Œæœªç™»å½•åˆ™è·³è½¬ç™»å½•
            favBtn.addEventListener('click', async () => {
                const product = window.currentProduct;
                const token = localStorage.getItem('kax_login_token');
                const icon = favBtn.querySelector('.material-icons');

                if (!token) { alert('è¯·å…ˆç™»å½•ä»¥ä½¿ç”¨æ”¶è—åŠŸèƒ½'); location.href = '/login'; return; }

                try {
                    const isActive = favBtn.classList.contains('active');
                    if (!isActive) {
                        const resp = await fetch('/api/user/favorites', {
                            method: 'POST',
                            headers: { 'Authorization': 'Bearer ' + token, 'Content-Type': 'application/json' },
                            body: JSON.stringify({ assetId: product.id })
                        });
                        if (resp.ok) {
                            favBtn.classList.add('active');
                            icon.textContent = 'favorite';
                        } else {
                            console.warn('æ”¶è—å¤±è´¥', resp.status);
                        }
                    } else {
                        const resp = await fetch(`/api/user/favorites/${product.id}`, {
                            method: 'DELETE',
                            headers: { 'Authorization': 'Bearer ' + token }
                        });
                        if (resp.ok) {
                            favBtn.classList.remove('active');
                            icon.textContent = 'favorite_border';
                        } else {
                            console.warn('å–æ¶ˆæ”¶è—å¤±è´¥', resp.status);
                        }
                    }
                } catch (e) {
                    console.error('æ”¶è—æ“ä½œå¤±è´¥', e);
                }
            });

            // æ£€æŸ¥æ˜¯å¦å·²æ”¶è—
            checkIfFavorited();

            // åˆ†äº«æŒ‰é’®
            shareBtn.addEventListener('click', () => {
                const product = window.currentProduct;
                const shareUrl = window.location.href;
                const shareText = `æˆ‘å‘ç°äº†ä¸€ä¸ªä¸é”™çš„æ¨¡ç»„ï¼š${product.name}ï¼Œä»·æ ¼ Â¥${product.price}ï¼Œå¿«æ¥çœ‹çœ‹å§ï¼`;

                if (navigator.share) {
                    navigator.share({
                        title: product.name,
                        text: shareText,
                        url: shareUrl
                    }).catch(err => console.log('åˆ†äº«å–æ¶ˆæˆ–å‡ºé”™:', err));
                } else {
                    // å¤åˆ¶åˆ°å‰ªè´´æ¿
                    navigator.clipboard.writeText(shareUrl).then(() => {
                        shareBtn.textContent = 'âœ“ é“¾æ¥å·²å¤åˆ¶';
                        setTimeout(() => {
                            shareBtn.innerHTML = '<span class="material-icons">share</span><span>åˆ†äº«</span>';
                        }, 2000);
                    });
                }
            });
        }

        // åˆ›å»ºé£è¡Œæ•ˆæœ
        function createFlyingIcon(fromRect, toRect) {
            const flying = document.createElement('div');
            flying.style.cssText = `
                position: fixed;
                left: ${fromRect.left}px;
                top: ${fromRect.top}px;
                width: 32px;
                height: 32px;
                font-size: 28px;
                z-index: 10000;
                pointer-events: none;
                display: flex;
                align-items: center;
                justify-content: center;
            `;
            flying.textContent = 'ğŸ›’';
            document.body.appendChild(flying);

            // åŠ¨ç”»
            requestAnimationFrame(() => {
                flying.style.transition = 'all 0.6s cubic-bezier(0.2, 0.8, 0.2, 1)';
                flying.style.left = (toRect.left + toRect.width / 2 - 16) + 'px';
                flying.style.top = (toRect.top + toRect.height / 2 - 16) + 'px';
                flying.style.opacity = '0';
                flying.style.transform = 'scale(0.5)';
            });

            setTimeout(() => flying.remove(), 600);
        }

        // æ£€æŸ¥æ˜¯å¦å·²æ”¶è—ï¼ˆä¼˜å…ˆä½¿ç”¨åç«¯ APIï¼Œæœªç™»å½•å›é€€æœ¬åœ°ï¼‰
        async function checkIfFavorited() {
            const product = window.currentProduct;
            const favBtn = document.getElementById('favBtn');
            const icon = favBtn && favBtn.querySelector('.material-icons');
            const token = localStorage.getItem('kax_login_token');

            if (token) {
                try {
                    const resp = await fetch('/api/user/favorites', { headers: { 'Authorization': 'Bearer ' + token } });
                    if (resp.ok) {
                        const j = await resp.json();
                        const arr = (j && j.data) ? j.data : [];
                        const ids = (Array.isArray(arr) ? arr : []).map(item => {
                            if (typeof item === 'number') return Number(item);
                            if (typeof item === 'string') return Number(item);
                            if (typeof item === 'object' && item != null) return Number(item.id != null ? item.id : (item.assetId != null ? item.assetId : NaN));
                            return NaN;
                        }).filter(n => !isNaN(n));
                        if (ids.includes(Number(product.id))) {
                            favBtn.classList.add('active');
                            if (icon) icon.textContent = 'favorite';
                            return;
                        }
                    }
                } catch (e) {
                    console.warn('æ£€æŸ¥æ”¶è—çŠ¶æ€å¤±è´¥ï¼Œå›é€€åˆ°æœ¬åœ°å­˜å‚¨', e);
                }
            }

            // æœ¬åœ°å›é€€
            const favorites = JSON.parse(localStorage.getItem('favorites') || '[]');
            if (favorites && favorites.includes(product.id)) {
                favBtn.classList.add('active');
                if (icon) icon.textContent = 'favorite';
            }
        }

        // æ›´æ–°è´­ç‰©è½¦è®¡æ•°ï¼ˆä¼˜å…ˆä½¿ç”¨åç«¯ APIï¼Œæœªç™»å½•å›é€€æœ¬åœ°ï¼‰
        async function updateCartBadge() {
            const cartCountEl = document.getElementById('cartCount');
            const token = localStorage.getItem('kax_login_token');
            if (!cartCountEl) return;

            if (token) {
                try {
                    const resp = await fetch('/api/user/cart', { headers: { 'Authorization': 'Bearer ' + token } });
                    if (resp.ok) {
                        const j = await resp.json();
                        const raw = (j && j.data) ? j.data : [];
                        // raw may be array of objects or ids
                        let count = 0;
                        if (Array.isArray(raw)) {
                            raw.forEach(item => {
                                if (item && typeof item === 'object') count += Number(item.quantity || 1);
                                else if (!isNaN(Number(item))) count += 1;
                            });
                        }
                        cartCountEl.textContent = count;
                        return;
                    }
                } catch (e) {
                    console.warn('è·å–è¿œç«¯è´­ç‰©è½¦å¤±è´¥ï¼Œå›é€€æœ¬åœ°', e);
                }
            }

            // æœ¬åœ°å›é€€
            const cart = JSON.parse(localStorage.getItem('cart') || '[]');
            const count = cart.reduce((sum, item) => sum + (item.quantity || 1), 0);
            cartCountEl.textContent = count;
        }

        // å¯¼èˆªåˆ°å…¶ä»–å•†å“è¯¦æƒ…
        function goToShopDetail(id) {
            window.location.href = `/shop/detail?id=${id}`;
        }

        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initPage);
        } else {
            initPage();
        }
    </script>
</body>

</html>