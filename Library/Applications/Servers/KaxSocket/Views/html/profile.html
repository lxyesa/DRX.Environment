<!doctype html>
<html lang="zh-CN">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>KaxHub - 个人资料</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  <link href="/css/global.css" rel="stylesheet">
  <script src="/js/avatarCache.js" defer></script>
  <script src="/js/global.js" defer></script>
  <script src="/components/inputbox.js" defer></script>
  <script src="/components/badge/userbadge.js" defer></script>
  <script src="/components/collapsible-card.js" defer></script>
  <link href="/css/profile.css" rel="stylesheet">
</head>

<body class="has-global-topbar">
  <div class="container">
    <!-- 错误页面 -->
    <div class="error-container" id="errorContainer">
      <div class="error-icon">⚠️</div>
      <div class="error-title">资料不存在</div>
      <div class="error-message">抱歉，你访问的用户资料不存在或已被删除。请检查 UID 是否正确。</div>
      <div class="error-actions">
        <button class="btn ghost" onclick="location.href='/'">返回首页</button>
        <button class="btn" onclick="location.href='/profile'">查看我的资料</button>
      </div>
    </div>

    <!-- 主要内容 -->
    <div id="mainContent">
      <div class="page-header" role="banner">
        <div class="brand">
          <div class="logo">◆</div>
          <div>
            <h1>个人资料</h1>
            <div class="lead">管理你的账户信息、偏好与安全设置</div>
          </div>
        </div>
        <div class="controls">
          <button class="btn ghost" id="backBtn">返回首页</button>
          <button class="btn" id="logoutBtn">登出</button>
        </div>
      </div>

      <main class="grid">
        <!-- 左侧：个人卡片 -->
        <aside class="card profile-card" aria-label="个人信息卡片">

          <!-- 头像区 -->
          <div class="profile-avatar-section">
            <div class="avatar" id="avatarContainer" title="上传头像（仅预览）" role="button" tabindex="0" aria-label="上传头像（仅预览）">
              <img id="avatarImg" src="/static/default-avatar.jpg" alt="头像" onerror="this.style.display='none'">
              <span id="avatarInitials">YY</span>
              <div class="avatar-overlay" aria-hidden="true">
                <span class="material-icons avatar-plus" aria-hidden="true">add</span>
              </div>
              <input id="avatarFile" type="file" accept="image/*" style="display:none" aria-hidden="true">
            </div>
            <div class="profile-identity">
              <div class="name" id="displayName">杨 瑶</div>
              <div class="meta" id="displayHandle">@yangyao • 管理员</div>
              <div class="badge-container" aria-hidden="false">
                <user-badge text="无徽章" variant="gray" aria-label="徽章：无"></user-badge>
              </div>
            </div>
          </div>

          <!-- 统计区 -->
          <div class="stats" aria-hidden="true">
            <div class="stat">
              <span class="num" id="statResourceCount">0</span>
              <span class="label">资源</span>
            </div>
            <div class="stat">
              <span class="num" id="statGold">0</span>
              <span class="label">金币</span>
            </div>
            <div class="stat">
              <span class="num" id="statRecentActivity">0</span>
              <span class="label">最近活动</span>
            </div>
          </div>

          <!-- 账户信息区 -->
          <div class="profile-info-section">
            <div class="info-section-label">账户信息</div>
            <div class="info-row">
              <div class="k">邮箱</div>
              <div class="v" id="email" title="yangyao@example.com">yangyao@example.com</div>
            </div>
            <div class="info-row">
              <div class="k">角色</div>
              <div class="v" id="role">管理员</div>
            </div>
            <div class="info-row">
              <div class="k">UID</div>
              <div class="v" id="uid">-</div>
            </div>
            <div class="info-row">
              <div class="k">封禁</div>
              <div class="v" id="banStatus">否</div>
            </div>
            <div class="info-row">
              <div class="k">注册时间</div>
              <div class="v" id="joined">2021-05-12</div>
            </div>
            <div class="info-row">
              <div class="k">上次登录</div>
              <div class="v" id="lastLogin">2026-02-17 09:12</div>
            </div>
            <div class="info-row">
              <div class="k">金币</div>
              <div class="v" id="gold">0</div>
            </div>
          </div>

        </aside>

        <!-- 右侧：表单和设置 -->
        <section class="profile-sections">

          <!-- 基本信息 -->
          <collapsible-card title="基本信息" subtitle="保存将调用 /api/user/profile" open aria-labelledby="basicTitle">
            <span slot="icon" class="material-icons">person</span>

            <form id="profileForm">
              <!-- 账户字段组 -->
              <div class="form-group">
                <div class="form-group-label">账户</div>
                <div class="form-grid">
                  <input-box id="inputName" label="显示名称" placeholder="显示名称" value="杨 瑶" size="small"></input-box>
                  <input-box id="inputHandle" label="用户名" placeholder="用户名" value="yangyao" readonly title="用户名不可修改" size="small"></input-box>
                  <input-box id="inputEmail" label="邮箱" placeholder="邮箱" type="email" value="yangyao@example.com" size="small"></input-box>
                  <input-box id="inputRole" label="角色" placeholder="角色" value="管理员" readonly title="由系统控制，无法修改" size="small"></input-box>
                </div>
              </div>

              <!-- 个性化字段组 -->
              <div class="form-group">
                <div class="form-group-label">个性化</div>
                <div class="form-field">
                  <input-box id="inputBio" label="个人简介" placeholder="介绍一下你自己" textarea rows="3" size="small"></input-box>
                </div>
                <div class="form-field">
                  <input-box id="inputSignature" label="个性签名" placeholder="输入个性签名" textarea rows="3" size="small"></input-box>
                </div>
              </div>

              <div class="form-actions">
                <button type="button" class="btn ghost" id="cancelBtn">取消</button>
                <button type="submit" class="btn" id="saveBtn">保存更改</button>
              </div>
            </form>
          </collapsible-card>

          <!-- 安全与偏好 -->
          <collapsible-card title="安全与偏好" subtitle="密码与安全设置">
            <span slot="icon" class="material-icons">security</span>

            <div class="password-section">
              <!-- 验证行 -->
              <div class="pw-block">
                <div class="pw-block-label">验证身份</div>
                <input-box id="pwOld" label="当前密码" placeholder="输入当前密码以继续" type="password" name="currentPassword" autocomplete="current-password" size="small"></input-box>
              </div>
              <!-- 新密码行 -->
              <div class="pw-block">
                <div class="pw-block-label">设置新密码</div>
                <div class="pw-row">
                  <input-box id="pw1" label="新密码" placeholder="至少 8 位" type="password" name="newPassword" minlength="8" autocomplete="new-password" size="small"></input-box>
                  <input-box id="pw2" label="确认新密码" placeholder="再次输入" type="password" name="confirmPassword" minlength="8" autocomplete="new-password" size="small"></input-box>
                </div>
              </div>
              <div class="pw-footer">
                <span class="small-hint">密码长度至少 8 位，区分大小写</span>
                <button class="btn" id="changePwBtn">更新密码</button>
              </div>
            </div>
          </collapsible-card>

          <!-- 资产管理 -->
          <collapsible-card title="资产管理" subtitle="查看激活资产或激活新 CDK">
            <span slot="icon" class="material-icons">inventory_2</span>

            <!-- 激活的资产部分 -->
            <div class="assets-management-section">
              <div class="assets-section-header">
                <h3 class="assets-section-title">已激活的资产</h3>
                <span id="assetsCount" class="assets-count-badge">加载中…</span>
              </div>
              <div id="assetsContainer" class="assets-container">
                <div id="assetsLoading" class="assets-state">
                  <span class="material-icons assets-state-icon spin">sync</span>
                  <span>正在加载资产列表…</span>
                </div>
                <div id="assetsEmpty" class="assets-state" style="display:none;">
                  <span class="material-icons assets-state-icon">inventory_2</span>
                  <span>暂无激活的资产</span>
                </div>
                <div id="assetsList" class="assets-list"></div>
              </div>
            </div>

            <!-- CDK 激活部分分隔 -->
            <div class="management-divider"></div>

            <!-- CDK 激活部分 -->
            <div class="cdk-management-section">
              <h3 class="cdk-section-title">激活新 CDK</h3>
              <div class="cdk-section">
                <div class="cdk-input-row">
                  <input-box id="cdkInput" label="CDK 代码" placeholder="XXXX-XXXX-XXXX-XXXX" autocomplete="off" show-action size="small">
                    <button id="activateCdkBtn" slot="action">激活</button>
                  </input-box>
                </div>

                <div id="cdkMessage" class="cdk-message" style="display:none;"></div>

                <div id="cdkResult" class="cdk-result" style="display:none;">
                  <span class="material-icons cdk-result-icon">check_circle</span>
                  <div>
                    <div class="cdk-result-title">激活成功</div>
                    <div id="cdkResultDetails" class="cdk-result-details"></div>
                  </div>
                </div>
              </div>
            </div>
          </collapsible-card>

        </section>
      </main>
    </div>
  </div>

  <!-- 弹出卡片：更变计划 -->
  <div class="modal-overlay" id="changePlanModal">
    <div class="modal-card">
      <div class="modal-header">
        <span class="material-icons icon">card_giftcard</span>
        <span>选择新套餐</span>
      </div>
      <div class="modal-body">
        <div id="planModalMessage"
          style="display:none;padding:8px 10px;border-radius:4px;background:rgba(239,68,68,0.1);color:var(--danger);font-size:0.9rem;margin-bottom:12px;">
        </div>
        <div id="planModalConfirm"
          style="display:none;padding:8px 10px;border-radius:4px;background:rgba(20,20,20,0.92);color:var(--muted-strong);font-size:0.9rem;margin-bottom:12px;">
          确认更变套餐将花费 <span id="planModalConfirmCost">💰0.00</span>，是否继续？
          <div style="margin-top:8px;display:flex;gap:8px;justify-content:flex-end;">
            <button class="btn ghost" id="planModalConfirmNo">取消</button>
            <button class="btn" id="planModalConfirmYes">确认</button>
          </div>
        </div>
        当前资源 <strong id="planModalAssetName">-</strong>
        将更变为其他套餐。更变套餐不会继承上个套餐的剩余时常。
      </div>
      <div class="plan-list" id="planList">
        <!-- 套餐列表由JavaScript动态生成 -->
      </div>
      <div class="modal-footer">
        <button class="btn ghost" onclick="closePlanModal()">取消</button>
        <button class="btn" id="confirmChangePlanBtn">确认更变</button>
      </div>
    </div>
  </div>

  <!-- 弹出卡片：取消订阅 -->
  <div class="modal-overlay" id="unsubscribeModal">
    <div class="modal-card">
      <div class="modal-header">
        <span class="material-icons icon" style="color: var(--danger);">warning</span>
        <span>取消订阅</span>
      </div>
      <div class="modal-warning">
        <span class="material-icons icon">error_outline</span>
        <span>此操作不可撤销</span>
      </div>
      <div class="modal-body">
        你即将取消订阅资源 <strong id="unsubscribeModalAssetName">-</strong>。
        <br><br>
        取消订阅后，该资产将直接从你的已激活资产中移除。你将失去对该资源的访问权限。
      </div>
      <div class="modal-footer">
        <button class="btn ghost" onclick="closeUnsubscribeModal()">我想再想想</button>
        <button class="btn" style="background: var(--danger); border-color: var(--danger); color: #fff;"
          id="confirmUnsubscribeBtn">确认取消订阅</button>
      </div>
    </div>
  </div>

  <script src="/js/profile.js"></script>
</body>

</html>