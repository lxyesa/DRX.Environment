<!doctype html>
<html lang="zh-CN">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>KaxHub - 个人资料</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  <link href="/global.css" rel="stylesheet">
  <script src="/global.js" defer></script>
  <script src="/components/inputbox.js" defer></script>
  <script src="/components/badge/userbadge.js" defer></script>
  <style>
    /* CSS variables and base styles — 与 assetadmin 保持一致的暗色扁平风格 */
    :root {
      --bg: #0f0f0f;
      --card: rgba(255, 255, 255, 0.02);
      --card-border: rgba(255, 255, 255, 0.05);
      --muted: rgba(255, 255, 255, 0.7);
      --muted-strong: rgba(255, 255, 255, 0.92);
      --accent: #3b82f6;
      --success: #22c55e;
      --danger: #ef4444;
      --radius: 8px;
      --max-width: 1100px;
      --transition: 0.18s ease;
    }

    html,
    body {
      height: 100%;
    }

    body {
      margin: 0;
      font-family: 'Poppins', system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
      background: var(--bg); /* 扁平化：移除所有背景渐变 */
      color: var(--muted-strong);
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }

    .container {
      max-width: var(--max-width);
      margin: 36px auto;
      padding: 24px;
    }

    .page-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      margin-bottom: 22px;
    }

    .brand {
      display: flex;
      gap: 14px;
      align-items: center;
    }

    .logo {
      width: 48px;
      height: 48px;
      border-radius: 10px;
      background: var(--accent);
      display: flex;
      align-items: center;
      justify-content: center;
      color: #fff;
      font-weight: 700;
      box-shadow: none;
      font-size: 1rem;
    }

    h1 {
      font-size: 1.25rem;
      margin: 0;
      font-weight: 700;
    }

    .lead {
      color: var(--muted);
      margin-top: 6px;
      font-weight: 300;
      font-size: 0.95rem;
    }

    .controls {
      display: flex;
      gap: 10px;
      align-items: center;
    }

    /* 使用全局样式：.btn / .btn.ghost / .btn.danger（位于 global.css），页面不再重复定义 */

    .grid {
      display: grid;
      grid-template-columns: 340px 1fr;
      gap: 18px;
    }

    @media (max-width: 768px) {
      .grid {
        grid-template-columns: 1fr;
      }
    }

    /* 卡片风格 */
    .card {
      background: var(--card);
      border: 1px solid var(--card-border);
      padding: 18px;
      border-radius: var(--radius);
      box-shadow: none;
    }

    /* 左侧个人卡片 */
    .profile-card {
      display: flex;
      flex-direction: column;
      gap: 14px;
      align-items: center;
      text-align: center;
      padding-top: 28px;
      padding-bottom: 28px;
    }

    .avatar {
      width: 120px;
      height: 120px;
      border-radius: 20px;
      background-color: #111827; /* 扁平化：移除渐变 */
      display: flex;
      align-items: center;
      justify-content: center;
      color: #fff;
      font-size: 36px;
      font-weight: 700;
      border: 4px solid rgba(255, 255, 255, 0.03);
      box-shadow: 0 10px 30px rgba(2, 6, 23, 0.6);
      overflow: hidden;
    }

    .avatar img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      display: block;
      transition: filter var(--transition), transform var(--transition);
    }

    .avatar { position: relative; cursor: pointer; }
    .avatar-overlay { position: absolute; inset: 0; display: flex; align-items: center; justify-content: center; background: rgba(0,0,0,0.32); border-radius: inherit; opacity: 0; transition: opacity var(--transition); pointer-events: none; }
    .avatar-plus { color: #fff; font-size: 28px; transform: scale(.6); transition: transform 0.22s cubic-bezier(.2,.9,.2,1), opacity var(--transition); opacity: 0; }
    .avatar:hover .avatar-overlay, .avatar:focus-within .avatar-overlay { opacity: 1; }
    .avatar:hover img, .avatar:focus-within img { filter: blur(2px) brightness(.9); transform: scale(1.02); }
    .avatar:hover .avatar-plus, .avatar:focus-within .avatar-plus { transform: scale(1); opacity: 1; }

    .name {
      display: flex;
      font-size: 1.05rem;
      font-weight: 700;
      color: var(--muted-strong);
      flex-direction: column;
      align-content: stretch;
      justify-content: flex-start;
      align-items: center;
    }

    .meta {
      color: var(--muted);
      font-size: 0.92rem;
      margin-top: 4px;
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    .stats {
      display: flex;
      gap: 10px;
      margin-top: 8px;
      width: 100%;
      justify-content: space-between;
    }

    .stat {
      background: rgba(255, 255, 255, 0.01);
      padding: 8px 10px;
      border-radius: 10px;
      flex: 1;
      text-align: center;
      border: 1px solid rgba(255, 255, 255, 0.02);
    }

    .stat .num {
      font-weight: 700;
      color: var(--muted-strong);
      display: block;
      font-size: 1rem;
    }

    .stat .label {
      color: var(--muted);
      font-size: 0.82rem;
      margin-top: 4px;
    }

    .profile-info {
      text-align: left;
      width: 100%;
      margin-top: 6px;
    }

    /* 徽章容器：固定宽度、两侧外边距 10px，居中显示子元素，高度自适应 */
    .badge-container {
      width: 140px; /* 由用户选择 */
      margin: 6px 10px 0 10px; /* top 小间距 + 左右 10px */
      display: flex;
      align-items: center;
      justify-content: center;
      height: auto;
    }

    .info-row {
      display: flex;
      gap: 10px;
      align-items: center;
      padding: 8px 10px;
      border-radius: 8px;
      transition: background .12s ease;
    }

    .info-row:hover {
      background: rgba(255, 255, 255, 0.01);
    }

    .info-row .k {
      width: 110px;
      color: var(--muted);
      font-weight: 600;
      font-size: 0.9rem;
    }

    .info-row .v {
      color: var(--muted-strong);
      font-size: 0.95rem;
      /* 不让子元素通过长词或不可换行内容撑开父元素，优先裁剪并显示省略号 */
      word-break: normal;
      overflow-wrap: anywhere;
      /* 可收缩以触发 ellipsis（不撑大父元素） */
      flex: 1 1 0%;
      min-width: 0;
      max-width: 100%;
      overflow: hidden; /* 保险：防止子元素溢出 */
      text-overflow: ellipsis;
      box-sizing: border-box;
    }

    /* 右侧表单/设置 */
    .section-title {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      margin-bottom: 12px;
    }

    .form-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
    }

    label {
      display: block;
      font-size: 0.85rem;
      color: var(--muted);
      margin-bottom: 6px;
      font-weight: 600;
    }

    input[type="text"],
    input[type="email"],
    input[type="password"],
    textarea,
    select {
      width: 100%;
      padding: 10px;
      border-radius: 8px;
      border: 1px solid rgba(255, 255, 255, 0.06);
      background: rgba(255, 255, 255, 0.01);
      color: var(--muted-strong);
      font-size: 0.95rem;
    }

     textarea {
       min-height: 96px;
       resize: vertical;
     }
     
    .actions {
      display: flex;
      gap: 8px;
      margin-top: 10px;
    }

    .small-hint {
      color: var(--muted);
      font-size: 0.9rem;
      margin-top: 8px;
    }

    /* 主题开关样式已移除（扁平化设计） */

    .activity-list {
      display: flex;
      flex-direction: column;
      gap: 8px;
      margin-top: 8px;
      max-height: 220px;
      overflow: auto;
      padding-right: 6px;
    }

    .activity-item {
      display: flex;
      gap: 10px;
      align-items: flex-start;
      padding: 8px;
      border-radius: 8px;
      background: rgba(255, 255, 255, 0.01);
      border: 1px solid rgba(255, 255, 255, 0.01);
    }

    .activity-item .dot {
      width: 10px;
      height: 10px;
      border-radius: 50%;
      background: var(--accent);
      margin-top: 6px;
      flex: 0 0 10px;
    }

    .activity-item .content {
      color: var(--muted);
      font-size: 0.92rem;
    }

    .danger-zone {
      margin-top: 12px;
      padding: 12px;
      border-radius: 8px;
      background: rgba(239, 68, 68, 0.02);
      border: 1px solid rgba(239, 68, 68, 0.07);
      color: var(--muted);
    }

    @media (max-width: 980px) {
      .grid { grid-template-columns: 1fr; }

      /* 修复：在平板及更宽设备保持纵向堆叠，避免横向溢出问题 */
      .profile-card { flex-direction: column; align-items: center; text-align: center; padding: 18px 12px; }

      .avatar { width:84px; height:84px; border-radius:12px; }
      .profile-info { margin-left:0; margin-top:8px; }

      .form-grid { grid-template-columns: 1fr; }
    }

    /* 极窄屏（手机）下才使用横向紧凑布局 */
    @media (max-width: 520px) {
      .profile-card { flex-direction: row; align-items: center; text-align: left; padding: 12px; }
      .avatar { width:64px; height:64px; border-radius:10px; }
      .profile-info { margin-left:12px; margin-top:0; }
    }

    /* 错误页面样式 */
    .error-container {
      display: none;
      text-align: center;
      padding: 60px 24px;
      min-height: 60vh;
      flex-direction: column;
      align-items: center;
      justify-content: center;
    }

    .error-container.show {
      display: flex;
    }

    .error-icon {
      font-size: 64px;
      color: var(--danger);
      margin-bottom: 24px;
      opacity: 0.8;
    }

    .error-title {
      font-size: 1.75rem;
      font-weight: 700;
      margin-bottom: 12px;
      color: var(--muted-strong);
    }

    .error-message {
      font-size: 1rem;
      color: var(--muted);
      margin-bottom: 32px;
      max-width: 500px;
    }

    .error-actions {
      display: flex;
      gap: 12px;
      justify-content: center;
      flex-wrap: wrap;
    }
  </style>
</head>

<body class="has-global-topbar">
  <div class="container">
    <!-- 错误页面 -->
    <div class="error-container" id="errorContainer">
      <div class="error-icon">⚠️</div>
      <div class="error-title">资料不存在</div>
      <div class="error-message">抱歉，你访问的用户资料不存在或已被删除。请检查 UID 是否正确。</div>
      <div class="error-actions">
        <button class="btn ghost" onclick="location.href='/'">返回首页</button>
        <button class="btn" onclick="location.href='/profile'">查看我的资料</button>
      </div>
    </div>

    <!-- 主要内容 -->
    <div id="mainContent">
      <div class="page-header" role="banner">
      <div class="brand">
        <div class="logo">◆</div>
        <div>
          <h1>个人资料</h1>
          <div class="lead">管理你的账户信息、偏好与安全设置</div>
        </div>
      </div>
      <div class="controls">
        <button class="btn ghost" id="backBtn">返回首页</button>
        <button class="btn" id="logoutBtn">登出</button>
      </div>
    </div>

    <main class="grid">
      <!-- 左侧：个人卡片 -->
      <aside class="card profile-card" aria-label="个人信息卡片">
        <div class="avatar" id="avatarContainer" title="上传头像（仅预览）" role="button" tabindex="0" aria-label="上传头像（仅预览）">
          <!-- 占位首字母 -->
          <img id="avatarImg" src="/static/default-avatar.jpg" alt="头像" onerror="this.style.display='none'">
          <span id="avatarInitials">YY</span>
          <!-- 悬停覆盖层 + 放大加号动画 -->
          <div class="avatar-overlay" aria-hidden="true"><span class="material-icons avatar-plus" aria-hidden="true">add</span></div>
          <!-- 隐藏文件输入（由头像触发） -->
          <input id="avatarFile" type="file" accept="image/*" style="display:none" aria-hidden="true">
        </div>

        <div class="profile-info" style="width:100%;">
          <div style="display:flex;align-items:center;justify-content:space-between;gap:10px;flex-direction: column;">
            <div>
              <div class="name" id="displayName">杨 瑶</div>
              <div class="meta" id="displayHandle">@yangyao • 管理员</div>
              <div class="badge-container" aria-hidden="false">
                <user-badge text="无徽章" variant="gray" aria-label="徽章：无"></user-badge>
              </div>
            </div>

          <div class="stats" aria-hidden="true">
            <div class="stat">
              <span class="num" id="statResourceCount">0</span>
              <span class="label">资源</span>
            </div>
            <div class="stat">
              <span class="num" id="statContribution">0</span>
              <span class="label">贡献值</span>
            </div>
            <div class="stat">
              <span class="num" id="statRecentActivity">0</span>
              <span class="label">最近活动</span>
            </div>
          </div>

          <div style="margin-top:10px;">
            <div class="info-row">
              <div class="k">邮箱</div>
              <div class="v" id="email" title="yangyao@example.com">yangyao@example.com</div>
            </div>
            <div class="info-row">
              <div class="k">角色</div>
              <div class="v" id="role">管理员</div>
            </div>
            <div class="info-row">
              <div class="k">UID</div>
              <div class="v" id="uid">-</div>
            </div>
            <div class="info-row">
              <div class="k">封禁</div>
              <div class="v" id="banStatus">否</div>
            </div>
            <div class="info-row">
              <div class="k">注册时间</div>
              <div class="v" id="joined">2021-05-12</div>
            </div>
            <div class="info-row">
              <div class="k">上次登录</div>
              <div class="v" id="lastLogin">2026-02-17 09:12</div>
            </div>
            <div class="info-row">
              <div class="k">贡献值</div>
              <div class="v" id="contribution">0</div>
            </div>
          </div>
        </div>
      </aside>

      <!-- 右侧：表单和设置 -->
      <section>
        <div class="card" aria-labelledby="basicTitle">
          <div class="section-title">
            <div style="display:flex;align-items:center;gap:8px;">
              <span class="material-icons" style="color:var(--accent);font-size:20px;">person</span>
              <h2 id="basicTitle" style="margin:0;font-size:1rem">基本信息</h2>
            </div>
            <div class="small-hint">已连接后端：保存将调用 /api/user/profile（需要登录）</div>
          </div>

          <form id="profileForm">
            <div class="form-grid">
              <div>
                <input-box id="inputName" label="显示名称" placeholder="显示名称" value="杨 瑶"></input-box>
              </div>
              <div>
                <input-box id="inputHandle" label="用户名" placeholder="用户名" value="yangyao" readonly title="用户名不可修改"></input-box>
              </div>
              <div>
                <input-box id="inputEmail" label="邮箱" placeholder="邮箱" type="email" value="yangyao@example.com"></input-box>
              </div>
              <div>
                <input-box id="inputRole" label="角色" placeholder="角色" value="管理员" readonly title="由系统控制，无法修改"></input-box>
              </div>
            </div>

            <div style="margin-top:12px;">
              <label for="inputBio">个人简介</label>
              <textarea id="inputBio">热爱开发与产品，负责 KaxHub 平台的后端与管理功能。</textarea>
            </div>

            <div style="margin-top:12px;">
              <input-box id="inputSignature" label="个性签名" placeholder="输入个性签名" textarea rows="3"></input-box>
            </div>

            <div class="actions" style="justify-content:flex-end;">
              <button type="button" class="btn ghost" id="cancelBtn">取消</button>
              <button type="submit" class="btn primary" id="saveBtn">保存更改</button>
            </div>
          </form>
        </div>

        <div class="card" style="margin-top:12px;">
          <div class="section-title">
            <div style="display:flex;align-items:center;gap:8px;">
              <span class="material-icons" style="color:var(--accent);font-size:20px;">security</span>
              <h3 style="margin:0;font-size:1rem">安全与偏好</h3>
            </div>
            <div class="small-hint">密码与安全设置</div>
          </div>

          <div style="display:flex;gap:12px;flex-wrap:wrap;">
            <div style="flex:1;min-width:220px;">
              <label>更改密码</label>
              <div style="display:flex;gap:8px;flex-direction:column;">
                <div style="display:flex;flex-direction:column;gap:6px;">
                  <input-box id="pwOld" label="当前密码" placeholder="当前密码" type="password" name="currentPassword" autocomplete="current-password"></input-box>
                </div>
                <div style="display:flex;gap:8px;">
                  <div style="flex:1;display:flex;flex-direction:column;gap:6px;">
                    <input-box id="pw1" label="新密码" placeholder="新密码" type="password" name="newPassword" minlength="8" autocomplete="new-password"></input-box>
                  </div>
                  <div style="flex:1;display:flex;flex-direction:column;gap:6px;">
                    <input-box id="pw2" label="确认新密码" placeholder="确认新密码" type="password" name="confirmPassword" minlength="8" autocomplete="new-password"></input-box>
                  </div>
                </div>
              </div>
              <div class="small-hint">密码长度至少 8 位</div>
              <div style="margin-top:8px;display:flex;justify-content:flex-end;">
                <button class="btn" id="changePwBtn">更新密码</button>
              </div>
            </div>
          </div>
        </div>

        <!-- 激活资产列表板块 -->
        <div class="card" style="margin-top:12px;" aria-labelledby="activeAssetsTitle">
          <div class="section-title">
            <div style="display:flex;align-items:center;gap:8px;">
              <span class="material-icons" style="color:var(--accent);font-size:20px;">verified</span>
              <span id="activeAssetsTitle" style="font-weight:700;color:var(--muted-strong);">激活的资产</span>
            </div>
            <span id="assetsCount" style="font-size:0.9rem;color:var(--muted);">加载中...</span>
          </div>

           <div id="assetsContainer" style="max-height:400px;overflow-y:auto;padding-right:6px;border-radius:4px;">
            <div id="assetsLoading" style="text-align:center;color:var(--muted);padding:12px;font-size:0.95rem;">
              正在加载资产列表...
            </div>
            <div id="assetsEmpty" style="display:none;text-align:center;color:var(--muted);padding:12px;font-size:0.95rem;">
              暂无激活的资产
            </div>
            <div id="assetsList" style="display:flex;flex-direction:column;gap:8px;"></div>
          </div>
        </div>

        <div class="card" style="margin-top:12px;">
          <div class="section-title">
            <div style="display:flex;align-items:center;gap:8px;">
              <span class="material-icons" style="color:var(--accent);font-size:20px;">card_giftcard</span>
              <h3 style="margin:0;font-size:1rem">CDK 激活</h3>
            </div>
            <div class="small-hint">输入 CDK 代码激活资源</div>
          </div>

          <div style="display:flex;flex-direction:column;gap:12px;">
            <div style="display:flex;gap:8px;flex-direction:row;">
              <div style="flex:1;">
                <input-box id="cdkInput" label="CDK 代码" placeholder="输入 CDK 代码" autocomplete="off"></input-box>
              </div>
              <div style="display:flex;align-items:flex-end;">
                <button class="btn" id="activateCdkBtn" style="height:fit-content;padding:8px 16px;">激活</button>
              </div>
            </div>

            <div id="cdkMessage" style="display:none;padding:12px;border-radius:8px;font-size:0.95rem;border:1px solid;"></div>

            <div id="cdkResult" style="display:none;padding:12px;border-radius:8px;background:rgba(34,197,94,0.1);border:1px solid rgba(34,197,94,0.3);">
              <div style="color:var(--success);font-weight:600;">✓ 激活成功</div>
              <div id="cdkResultDetails" style="color:var(--muted);font-size:0.9rem;margin-top:6px;"></div>
            </div>
          </div>
        </div>
      </section>
    </main>
    </div>
  </div>

  <script>
    // ================ 交互脚本：包含后端交互（登录检查、读取/保存资料） ==================
    // 所有注释使用中文，遵循项目约定

    const saveBtn = document.getElementById('saveBtn');
    const cancelBtn = document.getElementById('cancelBtn');
    // 包含自定义的 <input-box> 组件，确保脚本能找到所有输入控件
    const formInputs = Array.from(document.querySelectorAll('#profileForm input, #profileForm textarea, #profileForm input-box'));

    // 记录初始数据（将在从后端加载后填充），便于取消恢复
    let originalProfile = { name: '', handle: '', email: '', role: '', bio: '', signature: '', avatarSrc: '' };

    // 从 URL 中提取目标用户 uid（若存在），用于访问他人资料
    let targetUid = null;
    const pathParts = window.location.pathname.split('/').filter(p => p);
    if (pathParts.length >= 2 && pathParts[0] === 'profile' && pathParts[1]) {
      targetUid = pathParts[1];
    }

    // 当前登录用户的 uid（将在加载资料后设置）
    let currentUserUid = null;

    // 判断是否为查看他人资料
    let isViewingOtherProfile = false;

    // 格式化 Unix 时间（秒）为本地可读字符串
    function formatUnix(ts) {
      if (!ts || ts <= 0) return '-';
      try { return new Date(ts * 1000).toLocaleString(); } catch (e) { return '-'; }
    }

    // 将后端 permissionGroup 映射为可读角色名
    function mapPermissionToRole(n) {
      switch (Number(n)) {
        case 0: return '控制台';
        case 1: return 'Root';
        case 2: return '管理员';
        default: return '普通用户';
      }
    }

    // 显示错误页面并隐藏主要内容
    function showErrorPage(message = '资料不存在或已被删除。请检查 UID 是否正确。') {
      const errorContainer = document.getElementById('errorContainer');
      const mainContent = document.getElementById('mainContent');
      const errorMsg = errorContainer.querySelector('.error-message');
      
      if (errorMsg) {
        errorMsg.textContent = message;
      }
      
      errorContainer.classList.add('show');
      mainContent.style.display = 'none';
    }

    // 从后端读取用户资料并填充到表单（若未登录则重定向到 /login）
    async function loadProfileFromServer() {
      const token = localStorage.getItem('kax_login_token');
      if (!token) { location.href = '/login'; return; }

      try {
        // 确定要加载的资料端点：若指定了 targetUid 则加载他人资料，否则加载自己的
        const endpoint = targetUid ? `/api/user/profile/${targetUid}` : '/api/user/profile';
        
        // 检查本地缓存的头像，快速显示
        const cachedAvatar = localStorage.getItem('userAvatarCache');
        const cacheTimestamp = localStorage.getItem('userAvatarCacheTime');
        const now = Date.now();
        const cacheExpiry = 24 * 60 * 60 * 1000; // 24小时缓存

        if (cachedAvatar && cacheTimestamp && (now - parseInt(cacheTimestamp)) < cacheExpiry) {
          if (cachedAvatar !== '/default-avatar.jpg') {
            avatarImg.src = cachedAvatar;
            avatarImg.style.display = 'block';
            avatarInitials.style.display = 'none';
          } else {
            avatarImg.style.display = 'none';
            avatarInitials.style.display = 'block';
          }
        }

        const resp = await fetch(endpoint, { headers: { 'Authorization': 'Bearer ' + token } });
        if (resp.status === 200) {
          const data = await resp.json();
          const user = data.user || '';
          const displayName = data.displayName || user;
          const email = data.email || '';
          const bio = data.bio || '';
          const registeredAt = data.registeredAt || 0;
          const lastLoginAt = data.lastLoginAt || 0;
          const roleText = mapPermissionToRole(data.permissionGroup);

          // 新增：后端返回的 id 与封禁信息
          const uid = (typeof data.id !== 'undefined') ? data.id : null;
          const isBanned = !!data.isBanned;
          const banReason = data.banReason || '';
          const banExpiresAt = data.banExpiresAt || 0;

          // 先处理后端返回的持久化头像（若存在）
          const serverAvatar = data.avatarUrl || '';
          if (serverAvatar) {
            avatarImg.src = serverAvatar;
            avatarImg.style.display = 'block';
            avatarInitials.style.display = 'none';
            // 缓存头像URL
            localStorage.setItem('userAvatarCache', serverAvatar);
            localStorage.setItem('userAvatarCacheTime', Date.now().toString());
          }
          else {
            avatarImg.style.display = 'none';
            avatarInitials.style.display = 'block';
            // 缓存默认头像标记
            localStorage.setItem('userAvatarCache', '/default-avatar.jpg');
            localStorage.setItem('userAvatarCacheTime', Date.now().toString());
          }

          // 填充界面和表单
          document.getElementById('displayName').textContent = displayName;
          document.getElementById('displayHandle').textContent = '@' + user + ' • ' + roleText;
          document.getElementById('inputName').value = displayName;
          document.getElementById('inputHandle').value = user;
          document.getElementById('inputEmail').value = email;
          document.getElementById('inputRole').value = roleText;
          document.getElementById('inputBio').value = bio;
          document.getElementById('inputSignature').value = data.signature || '';

          const leftEmail = document.getElementById('email'); if (leftEmail) { leftEmail.textContent = email; leftEmail.title = email; }
          document.getElementById('joined').textContent = formatUnix(registeredAt);
          document.getElementById('lastLogin').textContent = formatUnix(lastLoginAt);

          // 填充新增的 UID 与封禁状态
          const uidEl = document.getElementById('uid'); if (uidEl) { uidEl.textContent = uid ? String(uid) : '-'; }
          const banEl = document.getElementById('banStatus'); if (banEl) {
            if (isBanned) {
              banEl.textContent = `是（到期: ${formatUnix(banExpiresAt)}${banReason ? ' 原因: ' + banReason : ''}）`;
              banEl.style.color = 'var(--danger)';
            } else {
              banEl.textContent = '否';
              banEl.style.color = '';
            }
          }

          // 填充统计数字（后端返回或 0）
          try {
            document.getElementById('statResourceCount').textContent = (data.resourceCount || 0).toString();
            document.getElementById('statContribution').textContent = (data.contribution || 0).toLocaleString();
          } catch (e) { /* 忽略 DOM 更新错误 */ }

          originalProfile = { name: displayName, handle: user, email: email, role: roleText, bio: bio, signature: data.signature || '', avatarSrc: serverAvatar || (avatarImg.src || '') };

          // 设置当前登录用户的 uid
          if (uid) {
            currentUserUid = uid;
          }

          // 判断是否查看他人资料：若指定了 targetUid 且与当前用户 uid 不同，则为查看他人资料
          if (targetUid && currentUserUid && targetUid !== String(currentUserUid)) {
            isViewingOtherProfile = true;
          } else {
            isViewingOtherProfile = false;
          }

          // 控制编辑功能的显示/隐藏
          updateEditableState();
        } else if (resp.status === 401) {
          // token 无效或过期
          localStorage.removeItem('kax_login_token');
          location.href = '/login';
        } else if (resp.status === 403) {
          alert('账号被封禁，无法访问资料页。');
          location.href = '/login';
        } else if (resp.status === 404) {
          // 用户不存在
          showErrorPage('抱歉，你访问的用户资料不存在或已被删除。请检查 UID 是否正确。');
        } else {
          console.warn('读取用户资料失败：', resp.status);
          showErrorPage('加载资料失败，请稍后重试。');
        }
      } catch (err) {
        console.error('加载用户资料时发生错误：', err);
        showErrorPage('加载资料时发生错误，请稍后重试。');
      }
    }

    // 根据是否查看他人资料来控制编辑功能的显示/隐藏
    function updateEditableState() {
      const profileForm = document.getElementById('profileForm');
      const saveBtn = document.getElementById('saveBtn');
      const cancelBtn = document.getElementById('cancelBtn');
      const avatarElement = document.querySelector('.avatar');
      const avatarOverlay = document.querySelector('.avatar-overlay');
      const avatarPlus = document.querySelector('.avatar-plus');

      if (isViewingOtherProfile) {
        // 隐藏编辑表单
        if (profileForm) profileForm.style.display = 'none';
        
        // 隐藏保存/取消按钮
        if (saveBtn) saveBtn.style.display = 'none';
        if (cancelBtn) cancelBtn.style.display = 'none';

        // 禁用头像修改：移除悬停效果和点击功能
        if (avatarElement) {
          avatarElement.style.cursor = 'default';
          avatarElement.style.pointerEvents = 'none';
        }
        if (avatarOverlay) avatarOverlay.style.display = 'none';
        if (avatarPlus) avatarPlus.style.display = 'none';
      } else {
        // 显示编辑表单
        if (profileForm) profileForm.style.display = 'block';
        
        // 显示保存/取消按钮
        if (saveBtn) saveBtn.style.display = 'inline-block';
        if (cancelBtn) cancelBtn.style.display = 'inline-block';

        // 启用头像修改
        if (avatarElement) {
          avatarElement.style.cursor = 'pointer';
          avatarElement.style.pointerEvents = 'auto';
        }
        if (avatarOverlay) avatarOverlay.style.display = 'flex';
        if (avatarPlus) avatarPlus.style.display = 'block';
      }
    }

    // 表单提交：保存到后端 /api/user/profile（需要登录）
    document.getElementById('profileForm').addEventListener('submit', async (ev) => {
      ev.preventDefault();

      // 防止在查看他人资料时提交表单
      if (isViewingOtherProfile) {
        alert('无法编辑他人资料');
        return;
      }

      const token = localStorage.getItem('kax_login_token');
      if (!token) { location.href = '/login'; return; }

      const displayName = document.getElementById('inputName').value.trim();
      const email = document.getElementById('inputEmail').value.trim();
      const bio = document.getElementById('inputBio').value || '';
      const signature = document.getElementById('inputSignature').value || '';

      saveBtn.disabled = true;
      try {
        // 1) 若用户选择了新的头像文件，先上传头像（avatarFile 为隐藏的 file input）
        const avatarFileEl = document.getElementById('avatarFile');
        if (avatarFileEl && avatarFileEl.files && avatarFileEl.files.length > 0) {
          const file = avatarFileEl.files[0];
          const fd = new FormData();
          fd.append('avatar', file, file.name);
          const upResp = await fetch('/api/user/avatar', { method: 'POST', headers: { 'Authorization': 'Bearer ' + token }, body: fd });
          const upJson = await upResp.json().catch(() => ({}));
          if (upResp.status === 200 || upResp.status === 201) {
            if (upJson.url) {
              avatarImg.src = upJson.url;
              avatarImg.style.display = 'block';
              avatarInitials.style.display = 'none';
              originalProfile.avatarSrc = upJson.url;
              // 更新头像缓存
              localStorage.setItem('userAvatarCache', upJson.url);
              localStorage.setItem('userAvatarCacheTime', Date.now().toString());
            }
          } else if (upResp.status === 401) {
            localStorage.removeItem('kax_login_token'); location.href = '/login'; return;
          } else {
            alert(upJson.message || '头像上传失败');
            saveBtn.disabled = false; return;
          }
        }

        // 2) 提交资料更新请求
        const resp = await fetch('/api/user/profile', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + token },
          body: JSON.stringify({ displayName: displayName, email: email, bio: bio, signature: signature })
        });

        const result = await resp.json().catch(() => ({}));
        if (resp.status === 200) {
          // 成功：同步 UI 与缓存
          document.getElementById('displayName').textContent = displayName || originalProfile.name;
          originalProfile.name = displayName || originalProfile.name;
          originalProfile.email = email || originalProfile.email;
          originalProfile.bio = bio || originalProfile.bio;
          originalProfile.signature = signature || originalProfile.signature;

          const leftEmail = document.getElementById('email'); if (leftEmail) { leftEmail.textContent = originalProfile.email; leftEmail.title = originalProfile.email; }
          alert(result.message || '资料已保存');
        } else if (resp.status === 401) {
          localStorage.removeItem('kax_login_token');
          location.href = '/login';
        } else {
          alert(result.message || ('保存失败：' + resp.status));
        }
      } catch (err) {
        console.error(err);
        alert('无法连接到服务器');
      } finally {
        saveBtn.disabled = false;
      }
    });

    // 取消：恢复到初始值（示例行为）
    cancelBtn.addEventListener('click', () => {
      document.getElementById('inputName').value = originalProfile.name;
      document.getElementById('inputHandle').value = originalProfile.handle;
      document.getElementById('inputEmail').value = originalProfile.email;
      document.getElementById('inputRole').value = originalProfile.role;
      document.getElementById('inputBio').value = originalProfile.bio;
      document.getElementById('inputSignature').value = originalProfile.signature;
      // 恢复左侧邮箱显示与 title
      const leftEmail = document.getElementById('email');
      if (leftEmail) { leftEmail.textContent = originalProfile.email; leftEmail.title = originalProfile.email; }
      // 恢复头像预览（从缓存或原始值）
      if (originalProfile.avatarSrc && !originalProfile.avatarSrc.endsWith('/default-avatar.jpg')) {
        avatarImg.src = originalProfile.avatarSrc;
        avatarImg.style.display = 'block';
        avatarInitials.style.display = 'none';
      } else {
        avatarImg.style.display = 'none';
        avatarInitials.style.display = 'block';
      }
    });

    // 头像上传预览（文件输入位于 .avatar 内，点击头像触发）
    const avatarFile = document.getElementById('avatarFile');
    const avatarImg = document.getElementById('avatarImg');
    const avatarInitials = document.getElementById('avatarInitials');
    const avatarContainer = document.getElementById('avatarContainer');

    // 点击 / 回车 / 空格 触发文件选择（仅在查看自己的资料时）
    avatarContainer.addEventListener('click', () => {
      if (!isViewingOtherProfile) {
        avatarFile.click();
      }
    });
    avatarContainer.addEventListener('keydown', (e) => {
      if (!isViewingOtherProfile && (e.key === 'Enter' || e.key === ' ')) {
        e.preventDefault();
        avatarFile.click();
      }
    });

    avatarFile.addEventListener('change', (ev) => {
      const file = ev.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = function (e) {
        avatarImg.src = e.target.result;
        avatarImg.style.display = 'block';
        avatarInitials.style.display = 'none';
        // 新头像仅为本地预览（不实际上传）
      };
      reader.readAsDataURL(file);
    });



    // 其他按钮：示例行为
    document.getElementById('logoutBtn').addEventListener('click', () => {
      localStorage.removeItem('kax_login_token');
      location.href = '/login';
    });
    document.getElementById('backBtn').addEventListener('click', () => location.href = '/');

    document.getElementById('changePwBtn').addEventListener('click', async () => {
      const pwOldEl = document.getElementById('pwOld');
      const pw1El = document.getElementById('pw1');
      const pw2El = document.getElementById('pw2');
      if (!pwOldEl || !pw1El || !pw2El) {
        alert('修改密码表单未加载完毕，请刷新页面后重试。');
        return;
      }

      const oldPw = pwOldEl.value || '';
      const newPw = pw1El.value || '';
      const confirmPw = pw2El.value || '';

      if (!oldPw) { alert('请输入当前密码'); return; }
      if (newPw.length < 8) { alert('新密码长度至少 8 位'); return; }
      if (newPw !== confirmPw) { alert('两次新密码不匹配'); return; }

      const token = localStorage.getItem('kax_login_token');
      if (!token) { location.href = '/login'; return; }

      const btn = document.getElementById('changePwBtn');
      if (!btn) return;
      btn.disabled = true;
      try {
        const resp = await fetch('/api/user/password', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + token },
          body: JSON.stringify({ oldPassword: oldPw, newPassword: newPw, confirmPassword: confirmPw })
        });

        const result = await resp.json().catch(() => ({}));
        if (resp.status === 200) {
          alert(result.message || '密码已更新');
          pwOldEl.value = '';
          pw1El.value = '';
          pw2El.value = '';
        } else if (resp.status === 401) {
          localStorage.removeItem('kax_login_token');
          location.href = '/login';
        } else {
          alert(result.message || ('修改失败：' + resp.status));
        }
      } catch (err) {
        console.error(err);
        alert('无法连接到服务器');
      } finally { btn.disabled = false; }
    });

    // 加载用户的激活资产列表
    async function loadActiveAssets() {
      const token = localStorage.getItem('kax_login_token');
      if (!token) return;

      const assetsLoading = document.getElementById('assetsLoading');
      const assetsEmpty = document.getElementById('assetsEmpty');
      const assetsList = document.getElementById('assetsList');
      const assetsCount = document.getElementById('assetsCount');

      try {
        const resp = await fetch('/api/user/assets/active', {
          headers: { 'Authorization': 'Bearer ' + token }
        });

        if (resp.status === 200) {
          const result = await resp.json().catch(() => ({}));
          const assets = result.data || [];

          assetsLoading.style.display = 'none';

          if (assets.length === 0) {
            assetsEmpty.style.display = 'block';
            assetsCount.textContent = '0 个';
          } else {
            assetsEmpty.style.display = 'none';
            assetsCount.textContent = `${assets.length} 个`;

            // 使用异步方式为每个 asset 请求名称（并缓存），避免阻塞主渲染
            const assetNameCache = {};
            async function fetchAssetName(id) {
              if (assetNameCache[id]) return assetNameCache[id];
              try {
                const r = await fetch(`/api/asset/name/${id}`);
                if (r.status === 200) {
                  const j = await r.json().catch(() => ({}));
                  assetNameCache[id] = j.name || `资源 #${id}`;
                  return assetNameCache[id];
                }
              } catch (e) { /* ignore */ }
              assetNameCache[id] = `资源 #${id}`;
              return assetNameCache[id];
            }

            assetsList.innerHTML = '';
            for (const asset of assets) {
              const activatedTime = new Date(asset.activatedAt).toLocaleString();
              let expiresText = '';
              let remainingText = '';

              if (asset.expiresAt === 0) {
                expiresText = '永久有效';
                remainingText = '无限期';
              } else {
                const expiresTime = new Date(asset.expiresAt);
                expiresText = expiresTime.toLocaleString();

                if (asset.remainingSeconds < 0) {
                  remainingText = '已过期';
                } else if (asset.remainingSeconds === 0) {
                  remainingText = '即将过期';
                } else {
                  const days = Math.floor(asset.remainingSeconds / 86400);
                  const hours = Math.floor((asset.remainingSeconds % 86400) / 3600);
                  if (days > 0) {
                    remainingText = `${days} 天 ${hours} 小时`;
                  } else if (hours > 0) {
                    remainingText = `${hours} 小时`;
                  } else {
                    remainingText = `${asset.remainingSeconds} 秒`;
                  }
                }
              }

              const name = await fetchAssetName(asset.assetId);

              assetsList.insertAdjacentHTML('beforeend', `
                <div style="padding:12px;border-radius:8px;background:rgba(255,255,255,0.01);border:1px solid rgba(255,255,255,0.05);">
                  <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;">
                    <div style="font-weight:600;color:var(--muted-strong);">${name}</div>
                    <div style="font-size:0.85rem;padding:4px 8px;border-radius:6px;background:${asset.remainingSeconds < 0 ? 'rgba(239,68,68,0.1)' : 'rgba(34,197,94,0.1)'};">
                      <span style="color:${asset.remainingSeconds < 0 ? 'var(--danger)' : 'var(--success)'};">${remainingText}</span>
                    </div>
                  </div>
                  <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;font-size:0.9rem;">
                    <div>
                      <div style="color:var(--muted);margin-bottom:2px;">激活时间</div>
                      <div style="color:var(--muted-strong);">${activatedTime}</div>
                    </div>
                    <div>
                      <div style="color:var(--muted);margin-bottom:2px;">过期时间</div>
                      <div style="color:var(--muted-strong);">${expiresText}</div>
                    </div>
                  </div>
                </div>
              `);
            }
          }
        } else if (resp.status === 401) {
          localStorage.removeItem('kax_login_token');
          location.href = '/login';
        } else {
          assetsLoading.style.display = 'none';
          assetsEmpty.style.display = 'block';
          assetsEmpty.textContent = '无法加载资产列表';
        }
      } catch (err) {
        console.error('加载激活资产时发生错误：', err);
        assetsLoading.style.display = 'none';
        assetsEmpty.style.display = 'block';
        assetsEmpty.textContent = '加载失败，请重试';
      }
    }

    // CDK 激活处理
    const cdkInput = document.getElementById('cdkInput');
    const activateCdkBtn = document.getElementById('activateCdkBtn');
    const cdkMessage = document.getElementById('cdkMessage');
    const cdkResult = document.getElementById('cdkResult');
    const cdkResultDetails = document.getElementById('cdkResultDetails');

    activateCdkBtn.addEventListener('click', async () => {
      const cdkCode = cdkInput.value || cdkInput.textContent.trim();
      if (!cdkCode) {
        // 显示错误：CDK为空
        cdkMessage.style.display = 'block';
        cdkMessage.style.background = 'rgba(239,68,68,0.1)';
        cdkMessage.style.borderColor = 'rgba(239,68,68,0.3)';
        cdkMessage.style.color = 'var(--danger)';
        cdkMessage.textContent = '错误：CDK为空，请输入有效的 CDK 代码';
        activateCdkBtn.textContent = '激活失败';
        setTimeout(() => {
          activateCdkBtn.textContent = '激活';
        }, 2000);
        return;
      }

      const token = localStorage.getItem('kax_login_token');
      if (!token) {
        location.href = '/login';
        return;
      }

      activateCdkBtn.disabled = true;
      activateCdkBtn.textContent = '激活中...';
      cdkMessage.style.display = 'none';
      cdkResult.style.display = 'none';

      try {
        const resp = await fetch('/api/cdk/activate', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': 'Bearer ' + token
          },
          body: JSON.stringify({ code: cdkCode })
        });

        const result = await resp.json().catch(() => ({}));

        if (resp.status === 200) {
          // 激活成功
          cdkResult.style.display = 'block';
          const details = [];
          if (result.assetId > 0) details.push(`获得资源 #${result.assetId}`);
          if (result.contributionValue > 0) details.push(`+${result.contributionValue} 贡献值`);
          if (result.description) details.push(result.description);
          cdkResultDetails.textContent = details.length > 0 ? details.join(' • ') : '资源已添加至您的库中';
          
          cdkInput.value = '';
          activateCdkBtn.textContent = '激活成功';
          
          // 2秒后恢复按钮
          setTimeout(() => {
            activateCdkBtn.textContent = '激活';
          }, 2000);

          // 刷新用户数据以显示更新的CDK数量
          try {
            await loadProfileFromServer();
            await loadActiveAssets();
          } catch (e) { /* 忽略刷新错误 */ }
        } else if (resp.status === 401) {
          // 未授权
          localStorage.removeItem('kax_login_token');
          location.href = '/login';
        } else {
          // 错误处理
          cdkMessage.style.display = 'block';
          cdkMessage.style.background = 'rgba(239,68,68,0.1)';
          cdkMessage.style.borderColor = 'rgba(239,68,68,0.3)';
          cdkMessage.style.color = 'var(--danger)';

          // 根据错误码显示相应的错误信息
          const code = result.code;
          if (code === 1) {
            cdkMessage.textContent = '错误：CDK为空';
            activateCdkBtn.textContent = '激活失败';
          } else if (code === 2) {
            cdkMessage.textContent = '错误：CDK错误或不存在';
            activateCdkBtn.textContent = '激活失败';
          } else if (code === 3) {
            cdkMessage.textContent = '错误：CDK已被使用';
            activateCdkBtn.textContent = '激活失败';
          } else {
            cdkMessage.textContent = result.message || ('激活失败：' + resp.status);
            activateCdkBtn.textContent = '激活失败';
          }

          setTimeout(() => {
            activateCdkBtn.textContent = '激活';
          }, 2000);
        }
      } catch (err) {
        console.error('CDK激活请求失败：', err);
        cdkMessage.style.display = 'block';
        cdkMessage.style.background = 'rgba(239,68,68,0.1)';
        cdkMessage.style.borderColor = 'rgba(239,68,68,0.3)';
        cdkMessage.style.color = 'var(--danger)';
        cdkMessage.textContent = '错误：无法连接到服务器';
        activateCdkBtn.textContent = '激活失败';
        setTimeout(() => {
          activateCdkBtn.textContent = '激活';
        }, 2000);
      } finally {
        activateCdkBtn.disabled = false;
      }
    });

    // CDK输入框回车激活
    cdkInput.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') {
        activateCdkBtn.click();
      }
    });

    // 初始化页面：先获取当前用户信息，再根据 targetUid 决定加载自己或他人的资料
    async function initializePage() {
      const token = localStorage.getItem('kax_login_token');
      if (!token) { location.href = '/login'; return; }

      try {
        // 先获取当前登录用户的 uid
        const currentResp = await fetch('/api/user/profile', { headers: { 'Authorization': 'Bearer ' + token } });
        if (currentResp.status === 200) {
          const currentData = await currentResp.json();
          currentUserUid = (typeof currentData.id !== 'undefined') ? currentData.id : null;

          // 若指定了 targetUid 且与当前用户不同，则标记为查看他人资料
          if (targetUid && currentUserUid && targetUid !== String(currentUserUid)) {
            isViewingOtherProfile = true;
          }
        }
      } catch (err) {
        console.error('获取当前用户信息失败：', err);
      }

      // 加载资料（自己或他人）
      await loadProfileFromServer();
      await loadActiveAssets();

      // 初始化：隐藏头像 img（如无真实图片）
      if (!avatarImg.src || avatarImg.src.endsWith('/default-avatar.jpg')) {
        avatarImg.style.display = 'none';
        avatarInitials.style.display = 'block';
      }

      // 初始化：为邮箱设置 title（方便 hover 查看完整文本）
      try {
        const emailEl = document.getElementById('email');
        if (emailEl && (!emailEl.title || emailEl.title.trim() === '')) {
          emailEl.title = emailEl.textContent.trim();
        }
      } catch (error) {
        console.warn('Failed to set email title:', error);
      }
    }

    // 页面加载完成后初始化
    initializePage();
  </script>
</body>

</html>