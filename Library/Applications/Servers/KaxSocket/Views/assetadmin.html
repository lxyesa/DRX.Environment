<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KaxHub - 资源控制台</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <link href="/global.css" rel="stylesheet">
    <script src="/global.js" defer></script>
    <style>
        /* 主题变量，与 cdk.html / index.html 保持一致 */
        :root {
            --bg: #0f0f0f;
            --muted: rgba(255, 255, 255, 0.75);
            --muted-strong: rgba(255, 255, 255, 0.9);
            --accent: #3b82f6;
            --white: #ffffff;
            --card-border: rgba(255, 255, 255, 0.05);
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Poppins', sans-serif;
            background: var(--bg);
            color: var(--white);
            -webkit-font-smoothing: antialiased;
        }

        .container {
            max-width: 1100px;
            margin: 40px auto;
            padding: 24px;
        }

        header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding-bottom: 8px;
            border-bottom: 1px solid rgba(255,255,255,0.02);
        }

        .brand {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .logo {
            width: 44px;
            height: 44px;
            border-radius: 8px;
            background: var(--accent);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            color: var(--white);
            font-size: 1rem;
            box-shadow: none;
        }

        h1 {
            font-size: 1.35rem;
            margin: 0;
            color: var(--white);
            font-weight: 700;
        }

        .lead {
            margin-top: 6px;
            color: var(--muted);
            font-weight: 300;
            font-size: 0.95rem;
        }

        .controls {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        /* 按钮样式已移入 global.css（统一维护） */

        .main-content {
            display: grid;
            grid-template-columns: 1fr 340px;
            gap: 18px;
            margin-bottom: 40px;
        }

        .sidebar {
            display: flex;
            flex-direction: column;
            gap: 18px;
        }

        .content-area {
            display: flex;
            flex-direction: column;
            gap: 18px;
        }

        .card {
            background: rgba(255, 255, 255, 0.02);
            border: 1px solid var(--card-border);
            padding: 18px;
            border-radius: 8px;
            box-shadow: none;
        }

        .card-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 12px;
            padding-bottom: 8px;
            border-bottom: 1px solid rgba(255,255,255,0.02);
        }

        .card-title {
            font-size: 1.05rem;
            font-weight: 700;
            color: var(--white);
            margin: 0;
        }

        .filters {
            display: flex;
            gap: 12px;
            align-items: center;
        }

        .search-section {
            margin-top: 6px;
            margin-bottom: 12px;
        }

        .search-bar {
            display: flex;
            gap: 8px;
            align-items: center;
            position: relative;
            background: rgba(255,255,255,0.01);
            border: 1px solid rgba(255,255,255,0.06);
            border-radius: 8px;
            padding: 4px 8px;
            transition: border-color .12s ease, box-shadow .12s ease, background .12s ease;
        }

        .search-bar:hover,
        .search-bar:focus-within {
            border-color: rgba(59,130,246,0.65);
            box-shadow: 0 6px 20px rgba(59,130,246,0.04); /* 轻微发光 */
            background: rgba(255,255,255,0.02);
        }

        .search-icon {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            color: rgba(255,255,255,0.44); /* 弱化图标 */
            font-size: 18px;
            flex: 0 0 auto;
            margin: 0 4px 0 4px;
        }

        /* 输入本身为透明、无边框 - 所有交互视觉都在容器上 */
        .search-input {
            flex: 1;
            padding: 8px 36px 8px 0; /* 左侧由图标占位，右侧留 spinner */
            height: 36px;
            border: none !important;
            background: transparent !important;
            color: rgba(255,255,255,0.92);
            font-size: 0.95rem;
            outline: none;
            font-family: 'Poppins', sans-serif;
        }

        /* 抑制 input 的默认 focus ring（防止内层高亮） */
        .search-bar :is(input, textarea):focus {
            outline: none !important;
            box-shadow: none !important;
            border-color: transparent !important;
        }

        .search-input::placeholder { color: rgba(255,255,255,0.35); }

        .search-spinner {
            position: absolute;
            right: 8px;
            top: 50%;
            transform: translateY(-50%);
            width: 18px;
            height: 18px;
            border: 2px solid rgba(255,255,255,0.08);
            border-top-color: var(--accent);
            border-radius: 50%;
            animation: spin .8s linear infinite;
            opacity: 0;
            pointer-events: none;
            transition: opacity .12s ease;
        }

        .search-spinner.active { opacity: 1; }

        @keyframes spin { to { transform: translateY(-50%) rotate(360deg); } }

        .asset-list-container {
            max-height: 420px;
            overflow-y: auto;
            border-radius: 8px;
        }

        .pagination {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding: 12px 0;
            border-top: 1px solid rgba(255,255,255,0.02);
            margin-top: 12px;
        }

        .page-info {
            color: var(--muted);
            font-size: 0.9rem;
            min-width: 80px;
            text-align: center;
        }

        .section-title {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 12px;
        }

        .section-title h2 {
            font-size: 1.05rem;
            margin: 0;
            color: var(--white);
            font-weight: 700;
        }

        label {
            display: block;
            margin-bottom: 6px;
            color: rgba(255, 255, 255, 0.8);
            font-size: 0.9rem;
            font-weight: 600;
        }

        input[type=text],
        textarea,
        select {
            width: 100%;
            padding: 10px;
            border-radius: 4px;
            border: 1px solid rgba(255, 255, 255, 0.06);
            background: rgba(255, 255, 255, 0.01);
            color: var(--white);
            font-family: 'Poppins', sans-serif;
            transition: border-color .12s ease, box-shadow .12s ease;
        }

        input[type=text]:focus,
        textarea:focus,
        select:focus {
            outline: none;
            border-color: rgba(59, 130, 246, 0.95);
            box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.04);
        }

        textarea {
            resize: vertical;
            min-height: 80px;
        }

        .hint {
            color: rgba(255, 255, 255, 0.7);
            font-size: 0.92rem;
        }

        .hidden {
            display: none;
        }

        /* WebKit/Chromium 滚动条 */
        #assetList::-webkit-scrollbar {
            width: 10px;
            height: 10px;
        }

        #assetList::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.02);
            border-radius: 10px;
        }

        #assetList::-webkit-scrollbar-thumb {
            background: rgba(59, 130, 246, 0.95);
            border-radius: 10px;
            border: 2px solid rgba(0, 0, 0, 0.12);
        }

        #assetList::-webkit-scrollbar-thumb:hover {
            background: rgba(59, 130, 246, 1);
        }

        /* 资源列表项 */
        .asset-list-item {
            padding: 12px 8px;
            border-bottom: 1px dashed rgba(255,255,255,0.03);
            transition: background .12s ease, transform .12s ease, box-shadow .12s ease;
            cursor: default;
            display: flex;
            align-items: center;
            justify-content: flex-start;
            outline: none;
            min-width: 0;
            height: 44px;
        }

        .asset-list-item:nth-child(odd) {
            background: rgba(255,255,255,0.005);
        }

        .asset-list-item:hover {
            background: transparent;
            transform: none;
            box-shadow: none;
        }

        .asset-list-item:focus {
            background: transparent;
            transform: none;
            box-shadow: none;
        }

        .asset-list-item.selected {
            background: rgba(255,255,255,0.02);
            box-shadow: none;
        }

        .asset-text {
            flex: 1 1 auto;
            overflow: hidden;
            min-width: 0;
            display: inline-block;
            vertical-align: middle;
            padding-right: 12px;
        }

        .asset-name {
            font-weight: 600;
            color: var(--muted-strong);
            font-size: 0.95rem;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        /* 状态徽章（可在名称内或右侧区域显示） */
        .status-badge,
        .asset-name .status-badge {
            font-size: 0.72rem;
            padding: 3px 6px;
            border-radius: 8px;
            background: rgba(239, 68, 68, 0.06);
            color: #ef4444;
            font-weight: 600;
            border: 1px solid rgba(239, 68, 68, 0.12);
            white-space: nowrap;
            display: inline-block;
        }

        .status-badge.active,
        .asset-name .status-badge.active {
            background: rgba(34, 197, 94, 0.06);
            color: #22c55e;
            border-color: rgba(34, 197, 94, 0.12);
        }

        /* 右侧固定区域用于放置状态徽章（保证每行对齐） */
        .asset-badge {
            display: flex;
            align-items: center;
            justify-content: flex-end;
            min-width: 72px; /* 固定宽度用于对齐 */
            margin-right: 6px;
        }

        .asset-meta {
            font-size: 0.8rem;
            color: var(--muted);
            display: block;
        }

        .asset-description {
            font-size: 0.75rem;
            color: var(--muted);
            display: none;
        }

        .asset-actions {
            display: flex;
            gap: 6px;
            align-items: center;
            flex: 0 0 auto;
        }

        /* info-btn 已迁移到 global.css */

        .asset-left {
            display: flex;
            gap: 12px;
            align-items: flex-start;
            flex: 1;
            min-width: 0;
        }

        .asset-icon {
            display: none;
        }

        /* 搜索输入专用样式（覆盖旧定义） */
        .search-input {
            padding: 8px 36px 8px 8px;
            height: 36px;
            border-radius: 4px;
            border: none;
            background: transparent;
            color: var(--white);
            width: 100%;
        }

        .search-bar .material-icons {
            color: var(--muted);
            font-size: 18px;
        }

        #assetDetailBackdrop {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.45);
            display: none;
            opacity: 0;
            z-index: 40;
            transition: opacity .18s ease;
        }

        #assetDetailBackdrop.open {
            display: block;
            opacity: 1;
        }

        #assetDetailPanel {
            position: fixed;
            right: 24px;
            top: 48px;
            bottom: 48px;
            width: clamp(320px, 36%, 560px);
            max-width: calc(100% - 48px);
            max-height: 88vh;
            border-radius: 12px;
            padding: 18px;
            z-index: 50;
            overflow: auto;
            transform: translateX(20px);
            opacity: 0;
            transition: transform .22s cubic-bezier(.2, .9, .2, 1), opacity .14s ease;
            box-shadow: none;
            color: #ffffff;
            background: rgba(255,255,255,0.02);
            border: 1px solid var(--card-border);
            /* 不在打开状态时阻止指针事件，避免遮挡后方控件 */
            pointer-events: none;
        }

        #assetDetailPanel.open {
            transform: translateX(0);
            opacity: 1;
            /* 打开时允许交互 */
            pointer-events: auto;
        }

        @media (max-width: 768px) {
            #assetDetailPanel {
                right: 0;
                left: 0;
                top: auto;
                bottom: 0;
                width: 100%;
                max-height: 92vh;
                border-radius: 12px 12px 0 0;
                transform: translateY(20px);
            }
            #assetDetailPanel.open {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .panel-header {
            display:flex;
            align-items:center;
            justify-content:space-between;
            gap:12px;
            margin-bottom:14px;
            padding-bottom:8px;
            border-bottom: 1px solid rgba(255,255,255,0.02);
        }

        .panel-title {
            font-weight:700;
            color:var(--white);
            font-size:1rem;
        }


        #assetDetailPanel pre {
            background: rgba(255,255,255,0.01);
            padding: 12px;
            border-radius: 8px;
            overflow: auto;
            font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, 'Roboto Mono', monospace;
            font-size:0.9rem;
            border: 1px solid rgba(255,255,255,0.02);
            color:var(--white);
            margin-top:8px;
        }

        #assetDetailPanel .hint {
            margin: 8px 0;
            color: var(--muted);
        }

        #assetDetailPanel .panel-section {
            margin-bottom: 14px;
        }

        #assetDetailPanel .panel-actions {
            display: flex;
            gap: 8px;
            align-items: center;
            margin-top: 12px;
        }

        #assetDetailPanel .panel-actions .btn {
            padding: 8px 10px;
            font-size: 0.95rem;
        }

        /* 响应式设计 */
        @media (max-width: 1024px) {
            .main-content {
                grid-template-columns: 1fr;
                gap: 18px;
            }
        }

        @media (max-width: 768px) {
            .container {
                padding: 16px;
            }
            
            header {
                flex-direction: column;
                align-items: flex-start;
                gap: 12px;
                margin-bottom: 24px;
            }
            
            .controls {
                width: 100%;
                justify-content: space-between;
            }
            
            .filters {
                flex-direction: column;
                gap: 8px;
                width: 100%;
            }
            
            .filters select {
                width: 100%;
            }
            
            .search-bar {
                flex-direction: column;
                gap: 8px;
            }
            
            .search-input {
                width: 100%;
            }
            
            .pagination {
                flex-direction: column;
                gap: 12px;
            }
        }

        footer {
            margin-top: 28px;
            color: rgba(255, 255, 255, 0.6);
            font-size: 0.9rem;
            text-align: center;
        }
    </style>
</head>

<body class="has-global-topbar">
    <!-- 页面内容默认隐藏，直到完成登录验证 -->
    <div id="page" class="hidden">
        <div class="container">
            <header>
                <div class="brand">
                    <div class="logo">◆</div>
                    <div>
                        <h1>资源管理</h1>
                        <p class="lead">KaxHub 核心资源管理控制台</p>
                    </div>
                </div>
                <div class="controls">
                    <button id="homeBtn" class="btn ghost">返回首页</button>
                    <button id="logoutBtn" class="btn">登出</button>
                </div>
            </header>

            <div class="main-content">
                <!-- 左侧：资源列表 -->
                <div class="content-area">
                    <div class="card">
                        <div class="card-header">
                            <h2 class="card-title">资源列表</h2>
                            <div class="filters">
                                <select id="sortSelect" class="btn ghost small" data-custom-select="true" aria-hidden="true" tabindex="-1" style="position:absolute;left:-9999px;width:1px;height:1px;overflow:hidden;">
                                    <option value="name">按名称排序</option>
                                    <option value="version">按版本排序</option>
                                    <option value="author">按作者排序</option>
                                    <option value="updated">按更新时间排序</option>
                                </select>
                                <!-- custom dropdown will be initialized from JS -->
                                <select id="statusFilter" class="btn ghost small" data-custom-select="true" aria-hidden="true" tabindex="-1" style="position:absolute;left:-9999px;width:1px;height:1px;overflow:hidden;">
                                    <option value="all">全部</option>
                                    <option value="active">活跃</option>
                                    <option value="deleted">已删除</option>
                                </select>
                                <!-- custom dropdown will be initialized from JS -->
                            </div>
                        </div>
                        
                        <div class="search-section">
                            <div class="search-bar" role="search" aria-label="搜索资源">
                                <span class="search-icon material-icons" aria-hidden="true">search</span>
                                <input id="searchInput" class="search-input" type="text" placeholder="搜索名称/作者/版本/描述" />
                                <span id="searchSpinner" class="search-spinner" aria-hidden="true" title="搜索中"></span>
                            </div>
                        </div>
                        
                        <div id="assetList" class="asset-list-container">
                            <p class="hint" style="text-align: center; padding: 40px 20px;">加载中...</p>
                        </div>
                        
                        <div class="pagination">
                            <button id="prevPageBtn" class="btn ghost small">上一页</button>
                            <div id="pageInfo" class="page-info">第 1 页</div>
                            <button id="nextPageBtn" class="btn ghost small">下一页</button>
                        </div>
                    </div>
                </div>

                <!-- 右侧：创建和修改 -->
                <div class="sidebar">
                    <!-- 创建资源卡片 -->
                    <div class="card">
                        <div class="card-header">
                            <h2 class="card-title">创建资源</h2>
                        </div>
                        <form id="createAssetForm">
                            <label for="createName">资源名称</label>
                            <input type="text" id="createName" placeholder="例如: ModName" required>

                            <label for="createVersion">版本</label>
                            <input type="text" id="createVersion" placeholder="例如: 1.0.0" required>

                            <label for="createAuthor">作者</label>
                            <input type="text" id="createAuthor" placeholder="资源作者名称" required>

                            <label for="createDescription">描述</label>
                            <textarea id="createDescription" placeholder="资源描述信息" rows="3"></textarea>

                            <label for="createPrice" style="margin-top:12px;">价格（分）</label>
                            <input type="text" id="createPrice" placeholder="例如: 100 表示 1.00 单位" />

                            <label for="createStock" style="margin-top:12px;">库存</label>
                            <input type="text" id="createStock" placeholder="例如: 100" />

                            <label for="createCategory" style="margin-top:12px;">分类</label>
                            <input type="text" id="createCategory" placeholder="例如: 模组" />

                            <label for="createOriginalPrice" style="margin-top:12px;">原始价格（分）</label>
                            <input type="text" id="createOriginalPrice" placeholder="例如: 100 表示 1.00 单位" />

                            <label for="createFileSize" style="margin-top:12px;">文件大小（字节）</label>
                            <input type="text" id="createFileSize" placeholder="例如: 1048576" />

                            <label for="createDiscountRate" style="margin-top:12px;">折扣率 (0.0-1.0)</label>
                            <input type="text" id="createDiscountRate" placeholder="例如: 0.20 表示 20%" />

                            <label for="createSalePrice" style="margin-top:12px;">折后价（分）</label>
                            <input type="text" id="createSalePrice" placeholder="例如: 80" />

                            <label for="createCompatibility" style="margin-top:12px;">兼容性</label>
                            <input type="text" id="createCompatibility" placeholder="例如: 1.16 - 1.20" />

                            <label for="createDownloads" style="margin-top:12px;">下载次数</label>
                            <input type="text" id="createDownloads" placeholder="例如: 1234" />

                            <label for="createUploadDate" style="margin-top:12px;">上传时间（Unix 秒）</label>
                            <input type="text" id="createUploadDate" placeholder="例如: 1670000000" />

                            <label for="createLicense" style="margin-top:12px;">许可证</label>
                            <input type="text" id="createLicense" placeholder="例如: MIT" />

                            <label for="createDownloadUrl" style="margin-top:12px;">下载地址</label>
                            <input type="text" id="createDownloadUrl" placeholder="例如: https://..." />

                            <button type="submit" class="btn" style="width: 100%; margin-top: 16px;">创建资源</button>
                            <p class="hint" style="margin-top: 12px; margin-bottom: 0; text-align: center;">创建新的资源项目</p>
                        </form>
                    </div>

                    <!-- 创建 CDK（快速） -->
                    <div class="card">
                        <div class="card-header">
                            <h2 class="card-title">创建 CDK</h2>
                        </div>
                        <form id="createCdkForm">
                            <label for="cdkAssetId">AssetId *</label>
                            <input type="text" id="cdkAssetId" placeholder="使用右侧已选资源ID（或手动填写）" />

                            <label for="cdkContributionValue" style="margin-top:12px;">贡献值（可选）</label>
                            <input type="text" id="cdkContributionValue" placeholder="0" value="0" />

                            <label for="cdkExpiresIn" style="margin-top:12px;">时效（可选，0表示永久）</label>
                            <div style="display: flex; gap: 8px; align-items: center;">
                                <input type="text" id="cdkExpiresInValue" placeholder="时间量" value="0" style="flex: 1;" />
                                <select id="cdkExpiresInUnit" style="flex: 0 0 auto; width: 80px;">
                                    <option value="0">永久</option>
                                    <option value="3600">小时</option>
                                    <option value="86400">天</option>
                                    <option value="604800">周</option>
                                    <option value="2592000">月</option>
                                </select>
                            </div>

                            <label for="cdkPrefix" style="margin-top:12px;">前缀（可选）</label>
                            <input type="text" id="cdkPrefix" placeholder="例如：CDK-" />

                            <label for="cdkCount" style="margin-top:12px;">生成数量</label>
                            <input type="text" id="cdkCount" placeholder="1 - 1000" value="10" />

                            <label for="cdkLength" style="margin-top:12px;">代码长度</label>
                            <input type="text" id="cdkLength" placeholder="4 - 256" value="8" />

                            <label for="cdkDesc" style="margin-top:12px;">描述（可选）</label>
                            <input type="text" id="cdkDesc" placeholder="为 CDK 添加描述" />

                            <div style="display:flex;gap:8px;margin-top:12px;">
                                <button type="submit" id="createCdkBtn" class="btn" style="flex:1;">生成并保存</button>
                                <button type="button" id="createCdkPreviewBtn" class="btn ghost" style="flex:1;">生成预览</button>
                            </div>

                            <label style="margin-top:12px;">生成结果</label>
                            <textarea id="createCdkResult" readonly style="min-height:80px;"></textarea>

                            <div style="display:flex;gap:8px;margin-top:8px;">
                                <button type="button" id="createCdkSaveBtn" class="btn" style="flex:1;">保存</button>
                                <button type="button" id="createCdkDownloadBtn" class="btn ghost" style="flex:1;">下载</button>
                            </div>
                            <p class="hint" style="margin-top: 12px; margin-bottom: 0; text-align: center;">为选中资源快速创建 CDK</p>
                        </form>
                    </div>

                    <!-- 修改资源卡片 -->
                    <div class="card">
                        <div class="card-header">
                            <h2 class="card-title">修改资源</h2>
                        </div>
                        <form id="updateAssetForm">
                            <label for="updateAssetId">选择资源</label>
                            <div style="display: flex; gap: 8px; margin-bottom: 16px; align-items: center;">
                                <input type="text" id="updateAssetId" placeholder="资源ID" required style="flex: 1;">
                                <button type="button" id="loadAssetBtn" class="btn ghost small">加载</button>
                            </div>

                            <label for="updateName">资源名称</label>
                            <input type="text" id="updateName" placeholder="资源名称">

                            <label for="updateVersion">版本</label>
                            <input type="text" id="updateVersion" placeholder="版本" required>

                            <label for="updateAuthor">作者</label>
                            <input type="text" id="updateAuthor" placeholder="作者" required>

                            <label for="updateDescription">描述</label>
                            <textarea id="updateDescription" placeholder="资源描述信息" rows="3"></textarea>

                            <label for="updatePrice" style="margin-top:12px;">价格（分）</label>
                            <input type="text" id="updatePrice" placeholder="例如: 100 表示 1.00 单位" />

                            <label for="updateStock" style="margin-top:12px;">库存</label>
                            <input type="text" id="updateStock" placeholder="例如: 100" />

                            <label for="updateCategory" style="margin-top:12px;">分类</label>
                            <input type="text" id="updateCategory" placeholder="例如: 模组" />

                            <label for="updateOriginalPrice" style="margin-top:12px;">原始价格（分）</label>
                            <input type="text" id="updateOriginalPrice" placeholder="例如: 100 表示 1.00 单位" />

                            <label for="updateFileSize" style="margin-top:12px;">文件大小（字节）</label>
                            <input type="text" id="updateFileSize" placeholder="例如: 1048576" />

                            <label for="updateDiscountRate" style="margin-top:12px;">折扣率 (0.0-1.0)</label>
                            <input type="text" id="updateDiscountRate" placeholder="例如: 0.20 表示 20%" />

                            <label for="updateSalePrice" style="margin-top:12px;">折后价（分）</label>
                            <input type="text" id="updateSalePrice" placeholder="例如: 80" />

                            <label for="updateCompatibility" style="margin-top:12px;">兼容性</label>
                            <input type="text" id="updateCompatibility" placeholder="例如: 1.16 - 1.20" />

                            <label for="updateDownloads" style="margin-top:12px;">下载次数</label>
                            <input type="text" id="updateDownloads" placeholder="例如: 1234" />

                            <label for="updateUploadDate" style="margin-top:12px;">上传时间（Unix 秒）</label>
                            <input type="text" id="updateUploadDate" placeholder="例如: 1670000000" />

                            <label for="updateLicense" style="margin-top:12px;">许可证</label>
                            <input type="text" id="updateLicense" placeholder="例如: MIT" />

                            <label for="updateDownloadUrl" style="margin-top:12px;">下载地址</label>
                            <input type="text" id="updateDownloadUrl" placeholder="例如: https://..." />

                            <button type="submit" class="btn" disabled id="updateBtn" style="width: 100%; margin-top: 16px;">更新资源</button>
                            <p class="hint" style="margin-top: 12px; margin-bottom: 0; text-align: center;">修改已有资源的信息</p>
                        </form>
                    </div>
                </div>
            </div>


        </div>
    </div>

    <!-- 详情面板 -->
    <div id="assetDetailBackdrop" aria-hidden="true"></div>
    <aside id="assetDetailPanel" aria-hidden="true" role="dialog" aria-labelledby="assetDetailTitle">
        <div class="panel-header">
            <h3 id="assetDetailTitle" class="panel-title">资源详情</h3>
            <button class="panel-close" id="closeDetailPanelBtn" aria-label="关闭">
                <span class="material-icons">close</span>
            </button>
        </div>
        <div id="assetDetailContent">
            <!-- 动态内容 -->
        </div>
    </aside>

    <div id="loading" style="min-height:60vh;display:flex;align-items:center;justify-content:center;color:rgba(255,255,255,0.7)"></div>

    <script>
        (function () {
            const page = document.getElementById('page');
            const loading = document.getElementById('loading');
            const logoutBtn = document.getElementById('logoutBtn');
            const homeBtn = document.getElementById('homeBtn');

            const createAssetForm = document.getElementById('createAssetForm');
            const updateAssetForm = document.getElementById('updateAssetForm');
            const loadAssetBtn = document.getElementById('loadAssetBtn');
            const updateBtn = document.getElementById('updateBtn');
            const assetList = document.getElementById('assetList');
            const searchInput = document.getElementById('searchInput');
            const searchSpinner = document.getElementById('searchSpinner');

            // 快速创建 CDK 元素
            const createCdkForm = document.getElementById('createCdkForm');
            const createCdkResult = document.getElementById('createCdkResult');
            const createCdkBtn = document.getElementById('createCdkBtn');
            const createCdkPreviewBtn = document.getElementById('createCdkPreviewBtn');
            const createCdkSaveBtn = document.getElementById('createCdkSaveBtn');
            const createCdkDownloadBtn = document.getElementById('createCdkDownloadBtn');
            const cdkAssetIdInput = document.getElementById('cdkAssetId');

            let currentSearchController = null;

            function setSearchLoading(on) {
                if (searchSpinner) {
                    searchSpinner.classList.toggle('active', !!on);
                    assetList.setAttribute('aria-busy', on ? 'true' : 'false');
                }
            }

            async function performSearch(q, page = 1) {
                // 取消上一次未完成的搜索请求
                if (currentSearchController) {
                    try { currentSearchController.abort(); } catch (e) { }
                    currentSearchController = null;
                }
                currentSearchController = new AbortController();
                const signal = currentSearchController.signal;

                setSearchLoading(true);
                try {
                    currentPage = page;
                    await loadAssetList(page, q, signal);
                } catch (err) {
                    if (err && err.name === 'AbortError') {
                        // 请求被取消，静默返回
                        return;
                    }
                    throw err;
                } finally {
                    setSearchLoading(false);
                    currentSearchController = null;
                }
            }
            function debounce(fn, wait) {
                let timeout = null;
                function debounced(...args) {
                    clearTimeout(timeout);
                    timeout = setTimeout(() => fn.apply(this, args), wait);
                }
                debounced.cancel = function () { clearTimeout(timeout); timeout = null; };
                return debounced;
            }

            const debouncedSearch = debounce(function () { performSearch(searchInput.value.trim(), 1); }, 300);

            if (searchInput) {
                searchInput.addEventListener('input', debouncedSearch);
                searchInput.addEventListener('keydown', function (ev) {
                    if (ev.key === 'Enter') { ev.preventDefault(); debouncedSearch.cancel && debouncedSearch.cancel(); performSearch(searchInput.value.trim(), 1); }
                });
            }

            const prevPageBtn = document.getElementById('prevPageBtn');
            const nextPageBtn = document.getElementById('nextPageBtn');
            const pageInfo = document.getElementById('pageInfo');
            let currentPage = 1;
            const pageSize = 20;

            const detailBackdrop = document.getElementById('assetDetailBackdrop');
            const detailPanel = document.getElementById('assetDetailPanel');
            const closeDetailBtn = document.getElementById('closeDetailPanelBtn');
            const detailContent = document.getElementById('assetDetailContent');

            /* initCustomSelects 已移入 /global.js（全局可复用） */
            /**
             * 验证 token 有效性
             */
            async function verifyToken() {
                try {
                    const token = localStorage.getItem('kax_login_token');
                    if (!token) {
                        location.href = '/login';
                        return;
                    }

                    const resp = await fetch('/api/user/verify/account', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': 'Bearer ' + token
                        }
                    });

                    if (resp.status === 200) {
                        page.classList.remove('hidden');
                        loading.classList.add('hidden');
                        initCustomSelects();
                        loadAssetList();
                        try { window.initGlobalFooter && window.initGlobalFooter(); } catch (_) { }
                        return;
                    } else {
                        location.href = '/login';
                    }
                } catch (err) {
                    console.error('验证失败', err);
                    location.href = '/login';
                }
            }

            /**
             * 加载资源列表
             */
            async function loadAssetList(page = 1, q = '', signal) {
                try {
                    const token = localStorage.getItem('kax_login_token');
                    const params = new URLSearchParams();
                    params.append('page', page.toString());
                    params.append('pageSize', pageSize.toString());
                    if (q) params.append('q', q);
                    
                    const sortSelect = document.getElementById('sortSelect');
                    const statusFilter = document.getElementById('statusFilter');
                    if (sortSelect.value !== 'name') params.append('sort', sortSelect.value);
                    if (statusFilter.value !== 'all') params.append('status', statusFilter.value);
                    
                    const resp = await fetch('/api/asset/admin/list?' + params.toString(), {
                        method: 'GET',
                        headers: {
                            'Authorization': 'Bearer ' + token
                        },
                        signal: signal
                    });

                    if (!resp.ok) throw new Error('加载失败');

                    const data = await resp.json();
                    const assets = data.data || [];

                    assetList.innerHTML = '';
                    if (assets.length === 0) {
                        assetList.innerHTML = '<p class="hint" style="text-align: center; padding: 20px 0;">暂无资源</p>';
                        return;
                    }

                    // 更新分页 UI
                    currentPage = data.page || page;
                    pageInfo.textContent = `第 ${currentPage} 页，共 ${data.total || assets.length} 条`;
                    prevPageBtn.disabled = currentPage <= 1;
                    nextPageBtn.disabled = (currentPage * pageSize) >= (data.total || assets.length);

                    assets.forEach(asset => {
                        const item = document.createElement('div');
                        item.className = 'asset-list-item';
const descriptionPreview = asset.description ? asset.description.substring(0, 100) + (asset.description.length > 100 ? '...' : '') : '无描述';
                    // 状态徽章放到右侧固定区域（保证对齐）
                    const statusBadgeHtml = asset.isDeleted
                        ? '<span class="status-badge">已删除</span>'
                        : '<span class="status-badge active">活跃</span>';

                    item.innerHTML = `
                            <div class="asset-left">
                                <span class="material-icons asset-icon">folder</span>
                                <div class="asset-text">
                                    <div class="asset-name">${escapeHtml(asset.name)}</div>
                                    <div class="asset-meta">v${escapeHtml(asset.version)} • ${escapeHtml(asset.author)}</div>
                                    <div class="asset-description">${escapeHtml(descriptionPreview)}</div>
                                </div>
                            </div>
                            <div class="asset-actions">
                                <div class="asset-badge">${statusBadgeHtml}</div>
                                <button class="info-btn" aria-label="查看详情">
                                    <span class="material-icons" style="font-size: 1rem;">info</span>
                                </button>
                                <button class="info-btn danger-icon" aria-label="删除" style="color: #ef4444;">
                                    <span class="material-icons" style="font-size: 1rem;">delete</span>
                                </button>
                            </div>
                        `;

                        const infoBtn = item.querySelector('.info-btn:not(.danger-icon)');
                        const deleteBtn = item.querySelector('.danger-icon');
                        // 如果已删除，显示恢复按钮而非删除
                        if (asset.isDeleted) {
                            deleteBtn.innerHTML = '<span class="material-icons" style="font-size: 1rem;">restore</span>';
                            deleteBtn.style.color = '#16a34a';
                        }

                        infoBtn.addEventListener('click', (e) => {
                            e.stopPropagation();
                            showAssetDetail(asset);
                        });

                        deleteBtn.addEventListener('click', async (e) => {
                            e.stopPropagation();
                            if (asset.isDeleted) {
                                if (confirm(`确定要恢复资源 "${asset.name}" 吗？`)) {
                                    await restoreAsset(asset.id);
                                }
                            } else {
                                if (confirm(`确定要删除资源 "${asset.name}" 吗？`)) {
                                    await deleteAsset(asset.id);
                                }
                            }
                        });

                        item.addEventListener('click', () => {
                            document.querySelectorAll('.asset-list-item').forEach(el => {
                                el.classList.remove('selected');
                            });
                            item.classList.add('selected');
                            document.getElementById('updateAssetId').value = asset.id;
                            // 同步到快速创建 CDK 表单（如果存在）
                            var _cdkEl = document.getElementById('cdkAssetId');
                            if (_cdkEl) _cdkEl.value = asset.id;
                        });

                        assetList.appendChild(item);
                    });
                } catch (err) {
                    if (err && err.name === 'AbortError') {
                        // 请求被取消 —— 静默返回
                        return;
                    }
                    console.error('加载资源列表失败', err);
                    assetList.innerHTML = '<p class="hint" style="text-align: center; padding: 20px 0;">加载失败</p>';
                }
            }

            /**
             * 显示资源详情
             */
            function showAssetDetail(asset) {
                const updatedTime = new Date(asset.lastUpdatedAt * 1000).toLocaleString('zh-CN');
                detailContent.innerHTML = `
                    <div class="panel-section">
                        <label>资源ID</label>
                        <pre>${asset.id}</pre>
                    </div>
                    <div class="panel-section">
                        <label>资源名称</label>
                        <pre>${escapeHtml(asset.name)}</pre>
                    </div>
                    <div class="panel-section">
                        <label>版本</label>
                        <pre>${escapeHtml(asset.version)}</pre>
                    </div>
                    <div class="panel-section">
                        <label>作者</label>
                        <pre>${escapeHtml(asset.author)}</pre>
                    </div>
                    <div class="panel-section">
                        <label>描述</label>
                        <pre>${escapeHtml(asset.description)}</pre>
                    </div>
                    <div class="panel-section">
                        <label>最后更新</label>
                        <p class="hint">${updatedTime}</p>
                    </div>
                    <div class="panel-actions">
                        <button class="btn" style="flex: 1;" onclick="loadToUpdateForm(${asset.id})">编辑</button>
                        <button class="btn danger" style="flex: 1;" onclick="confirmDelete(${asset.id})">删除</button>
                    </div>
                `;
                detailPanel.classList.add('open');
                detailBackdrop.classList.add('open');
            }

            /**
             * 关闭详情面板
             */
            function closeDetailPanel() {
                detailPanel.classList.remove('open');
                detailBackdrop.classList.remove('open');
            }

            /**
             * 加载资源到修改表单
             */
            async function loadToUpdateForm(assetId) {
                try {
                    const token = localStorage.getItem('kax_login_token');
                    const resp = await fetch('/api/asset/admin/inspect', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': 'Bearer ' + token
                        },
                        body: JSON.stringify({ id: assetId })
                    });

                    if (!resp.ok) throw new Error('加载失败');
                    const data = await resp.json();
                    const asset = data.data;

                    document.getElementById('updateAssetId').value = asset.id;
                    document.getElementById('updateName').value = asset.name;
                    document.getElementById('updateVersion').value = asset.version;
                    document.getElementById('updateAuthor').value = asset.author;
                    document.getElementById('updateDescription').value = asset.description;
                    // 如果后端提供 price/stock 字段则填充
                    try { document.getElementById('updatePrice').value = asset.price || 0; } catch (_) {}
                    try { document.getElementById('updateStock').value = asset.stock || 0; } catch (_) {}
                    // 填充新增字段（兼容性：部分字段可能不存在）
                    try { document.getElementById('updateCategory').value = asset.category || asset.type || ''; } catch (_) {}
                    try { document.getElementById('updateOriginalPrice').value = asset.originalPrice || 0; } catch (_) {}
                    try { document.getElementById('updateFileSize').value = asset.fileSize || 0; } catch (_) {}
                    try { document.getElementById('updateDiscountRate').value = (asset.discountRate !== undefined && asset.discountRate !== null) ? asset.discountRate : 0.0; } catch (_) {}
                    try { document.getElementById('updateSalePrice').value = asset.salePrice || 0; } catch (_) {}
                    try { document.getElementById('updateCompatibility').value = asset.compatibility || ''; } catch (_) {}
                    try { document.getElementById('updateDownloads').value = asset.downloads || 0; } catch (_) {}
                    try { document.getElementById('updateUploadDate').value = asset.uploadDate || asset.lastUpdatedAt || 0; } catch (_) {}
                    try { document.getElementById('updateLicense').value = asset.license || ''; } catch (_) {}
                    try { document.getElementById('updateDownloadUrl').value = asset.downloadUrl || ''; } catch (_) {}
                    document.getElementById('updateBtn').disabled = false;

                    closeDetailPanel();
                } catch (err) {
                    console.error('加载资源失败', err);
                    alert('加载资源失败');
                }
            }

            /**
             * 确认删除
             */
            async function confirmDelete(assetId) {
                if (confirm('确定要删除此资源吗？此操作不可恢复。')) {
                    await deleteAsset(assetId);
                }
            }

            /**
             * 删除资源
             */
            async function deleteAsset(assetId) {
                try {
                    const token = localStorage.getItem('kax_login_token');
                    const resp = await fetch('/api/asset/admin/delete', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': 'Bearer ' + token
                        },
                        body: JSON.stringify({ id: assetId })
                    });

                    if (resp.status === 200) {
                        alert('资源已删除');
                        closeDetailPanel();
                        loadAssetList();
                    } else {
                        const error = await resp.json();
                        alert(`删除失败: ${error.message || '未知错误'}`);
                    }
                } catch (err) {
                    console.error('删除资源失败', err);
                    alert('删除失败');
                }
            }

            /**
             * 恢复资源（软删除恢复）
             */
            async function restoreAsset(assetId) {
                try {
                    const token = localStorage.getItem('kax_login_token');
                    const resp = await fetch('/api/asset/admin/restore', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': 'Bearer ' + token
                        },
                        body: JSON.stringify({ id: assetId })
                    });

                    if (resp.status === 200) {
                        alert('资源已恢复');
                        closeDetailPanel();
                        loadAssetList(currentPage, searchInput.value.trim());
                    } else {
                        const error = await resp.json();
                        alert(`恢复失败: ${error.message || '未知错误'}`);
                    }
                } catch (err) {
                    console.error('恢复资源失败', err);
                    alert('恢复失败');
                }
            }

            /**
             * 转义 HTML 特殊字符
             */
            function escapeHtml(text) {
                if (!text) return '';
                const map = {
                    '&': '&amp;',
                    '<': '&lt;',
                    '>': '&gt;',
                    '"': '&quot;',
                    "'": '&#039;'
                };
                return text.replace(/[&<>"']/g, m => map[m]);
            }

            /**
             * 创建资源
             */
            createAssetForm.addEventListener('submit', async (e) => {
                e.preventDefault();

                const name = document.getElementById('createName').value.trim();
                const version = document.getElementById('createVersion').value.trim();
                const author = document.getElementById('createAuthor').value.trim();
                const description = document.getElementById('createDescription').value.trim();
                const price = parseInt(document.getElementById('createPrice').value, 10) || 0;
                const stock = parseInt(document.getElementById('createStock').value, 10) || 0;
                const category = document.getElementById('createCategory').value.trim();
                const originalPrice = parseInt(document.getElementById('createOriginalPrice').value, 10) || 0;
                const fileSize = parseInt(document.getElementById('createFileSize').value, 10) || 0;
                const discountRate = parseFloat(document.getElementById('createDiscountRate').value) || 0.0;
                const salePrice = parseInt(document.getElementById('createSalePrice').value, 10) || 0;
                const compatibility = document.getElementById('createCompatibility').value.trim();
                const downloads = parseInt(document.getElementById('createDownloads').value, 10) || 0;
                const uploadDate = parseInt(document.getElementById('createUploadDate').value, 10) || 0;
                const license = document.getElementById('createLicense').value.trim();
                const downloadUrl = document.getElementById('createDownloadUrl').value.trim();

                try {
                    const token = localStorage.getItem('kax_login_token');
                    const resp = await fetch('/api/asset/admin/create', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': 'Bearer ' + token
                        },
                        body: JSON.stringify({ name, version, author, description, price, stock,
                            category, originalPrice, fileSize, discountRate, salePrice, compatibility, downloads, uploadDate, license, downloadUrl })
                    });

                    if (resp.status === 200) {
                        alert('资源创建成功');
                        createAssetForm.reset();
                        loadAssetList();
                    } else {
                        const error = await resp.json().catch(() => ({}));
                        alert(`创建失败: ${error.message || '未知错误'}`);
                    }
                } catch (err) {
                    console.error('创建资源失败', err);
                    alert('创建失败');
                }
            });

            // ========== 快速创建 CDK ==========
            if (createCdkForm) {
                createCdkForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    var assetId = parseInt(document.getElementById('cdkAssetId').value, 10) || 0;
                    var contributionValue = parseInt(document.getElementById('cdkContributionValue').value, 10) || 0;
                    var expiresInValue = parseInt(document.getElementById('cdkExpiresInValue').value, 10) || 0;
                    var expiresInUnit = parseInt(document.getElementById('cdkExpiresInUnit').value, 10) || 0;
                    var expiresInSeconds = expiresInValue > 0 ? expiresInValue * expiresInUnit : 0;
                    var prefix = document.getElementById('cdkPrefix').value.trim();
                    var count = parseInt(document.getElementById('cdkCount').value, 10) || 1;
                    var length = parseInt(document.getElementById('cdkLength').value, 10) || 8;
                    var description = document.getElementById('cdkDesc').value.trim();

                    if (assetId <= 0) { alert('请输入有效的 AssetId'); return; }
                    count = Math.max(1, Math.min(1000, count));
                    length = Math.max(4, Math.min(256, length));

                    try {
                        var btn = document.getElementById('createCdkBtn');
                        var orig = btn.textContent;
                        btn.disabled = true;
                        btn.textContent = '生成并保存...';

                        var token = localStorage.getItem('kax_login_token');
                        var genResp = await fetch('/api/cdk/admin/generate', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + token },
                            body: JSON.stringify({ prefix: prefix, count: count, length: length })
                        });
                        if (!genResp.ok) throw new Error('生成失败');
                        var genData = await genResp.json();
                        var codes = genData.codes || [];

                        var saveResp = await fetch('/api/cdk/admin/save', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + token },
                            body: JSON.stringify({ codes: codes, assetId: assetId, contributionValue: contributionValue, expiresInSeconds: expiresInSeconds, description: description })
                        });

                        if (saveResp.status === 200 || saveResp.status === 201) {
                            alert('已生成并保存 ' + (codes.length) + ' 条 CDK');
                            document.getElementById('createCdkResult').value = codes.join('\n');
                            loadAssetList();
                        } else {
                            var err = await saveResp.json();
                            throw new Error(err.message || '保存失败');
                        }
                    } catch (err) {
                        alert('操作失败：' + (err.message || err));
                    } finally {
                        var btn = document.getElementById('createCdkBtn');
                        if (btn) { btn.disabled = false; btn.textContent = '生成并保存'; }
                    }
                });

                // 仅生成预览（不保存）
                createCdkPreviewBtn && createCdkPreviewBtn.addEventListener('click', async function () {
                    var prefix = document.getElementById('cdkPrefix').value.trim();
                    var count = parseInt(document.getElementById('cdkCount').value, 10) || 1;
                    var length = parseInt(document.getElementById('cdkLength').value, 10) || 8;
                    count = Math.max(1, Math.min(1000, count));
                    length = Math.max(4, Math.min(256, length));
                    try {
                        var token = localStorage.getItem('kax_login_token');
                        var resp = await fetch('/api/cdk/admin/generate', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + token },
                            body: JSON.stringify({ prefix: prefix, count: count, length: length })
                        });
                        if (!resp.ok) throw new Error('生成失败');
                        var data = await resp.json();
                        document.getElementById('createCdkResult').value = (data.codes || []).join('\n');
                    } catch (err) {
                        alert('生成失败：' + (err.message || err));
                    }
                });

                // 单独保存（从结果区域）
                createCdkSaveBtn && createCdkSaveBtn.addEventListener('click', async function () {
                    var txt = document.getElementById('createCdkResult').value || '';
                    if (!txt) { alert('无生成代码可保存'); return; }
                    var codes = txt.split(/\r?\n/).filter(Boolean);
                    var assetId = parseInt(document.getElementById('cdkAssetId').value, 10) || 0;
                    var contributionValue = parseInt(document.getElementById('cdkContributionValue').value, 10) || 0;
                    var expiresInValue = parseInt(document.getElementById('cdkExpiresInValue').value, 10) || 0;
                    var expiresInUnit = parseInt(document.getElementById('cdkExpiresInUnit').value, 10) || 0;
                    var expiresInSeconds = expiresInValue > 0 ? expiresInValue * expiresInUnit : 0;
                    var description = document.getElementById('cdkDesc').value.trim();
                    if (assetId <= 0) { alert('请填写有效的 AssetId'); return; }

                    try {
                        var btn = document.getElementById('createCdkSaveBtn');
                        var orig = btn.textContent;
                        btn.disabled = true;
                        btn.textContent = '保存中...';

                        var token = localStorage.getItem('kax_login_token');
                        var resp = await fetch('/api/cdk/admin/save', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + token },
                            body: JSON.stringify({ codes: codes, assetId: assetId, contributionValue: contributionValue, expiresInSeconds: expiresInSeconds, description: description })
                        });
                        var data = await resp.json();
                        if (resp.status === 200 || resp.status === 201) {
                            alert('已保存 ' + (data.count || codes.length) + ' 条 CDK');
                            loadAssetList();
                        } else {
                            alert('保存失败: ' + (data.message || '未知错误'));
                        }
                    } catch (err) {
                        alert('保存失败: ' + (err.message || err));
                    } finally {
                        var btn = document.getElementById('createCdkSaveBtn');
                        if (btn) { btn.disabled = false; btn.textContent = '保存'; }
                    }
                });

                // 下载结果
                createCdkDownloadBtn && createCdkDownloadBtn.addEventListener('click', function () {
                    var txt = document.getElementById('createCdkResult').value;
                    if (!txt) { alert('无内容可下载'); return; }
                    var blob = new Blob([txt], { type: 'text/plain' });
                    var url = URL.createObjectURL(blob);
                    var a = document.createElement('a');
                    a.href = url;
                    a.download = 'cdks_' + new Date().getTime() + '.txt';
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                });
            }

            /**
             * 加载按钮
             */
            loadAssetBtn.addEventListener('click', async (e) => {
                e.preventDefault();
                const assetId = document.getElementById('updateAssetId').value;
                if (!assetId) {
                    alert('请输入资源ID');
                    return;
                }
                await loadToUpdateForm(parseInt(assetId));
            });

            // 搜索由输入变更（debounced）或按 Enter 触发；不再使用独立按钮

            prevPageBtn.addEventListener('click', async (e) => {
                e.preventDefault();
                if (currentPage > 1) {
                    currentPage--;
                    await loadAssetList(currentPage, searchInput.value.trim());
                }
            });

            nextPageBtn.addEventListener('click', async (e) => {
                e.preventDefault();
                currentPage++;
                await loadAssetList(currentPage, searchInput.value.trim());
            });

            /**
             * 更新资源
             */
            updateAssetForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const id = parseInt(document.getElementById('updateAssetId').value);
                const name = document.getElementById('updateName').value.trim();
                const version = document.getElementById('updateVersion').value.trim();
                const author = document.getElementById('updateAuthor').value.trim();
                const description = document.getElementById('updateDescription').value.trim();
                const price = parseInt(document.getElementById('updatePrice').value, 10) || 0;
                const stock = parseInt(document.getElementById('updateStock').value, 10) || 0;
                const category = document.getElementById('updateCategory').value.trim();
                const originalPrice = parseInt(document.getElementById('updateOriginalPrice').value, 10) || 0;
                const fileSize = parseInt(document.getElementById('updateFileSize').value, 10) || 0;
                const discountRate = parseFloat(document.getElementById('updateDiscountRate').value) || 0.0;
                const salePrice = parseInt(document.getElementById('updateSalePrice').value, 10) || 0;
                const compatibility = document.getElementById('updateCompatibility').value.trim();
                const downloads = parseInt(document.getElementById('updateDownloads').value, 10) || 0;
                const uploadDate = parseInt(document.getElementById('updateUploadDate').value, 10) || 0;
                const license = document.getElementById('updateLicense').value.trim();
                const downloadUrl = document.getElementById('updateDownloadUrl').value.trim();

                try {
                    const token = localStorage.getItem('kax_login_token');
                    const resp = await fetch('/api/asset/admin/update', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': 'Bearer ' + token
                        },
                        body: JSON.stringify({ id, name, version, author, description, price, stock,
                            category, originalPrice, fileSize, discountRate, salePrice, compatibility, downloads, uploadDate, license, downloadUrl })
                    });

                    if (resp.status === 200) {
                        alert('资源已更新');
                        updateAssetForm.reset();
                        document.getElementById('updateBtn').disabled = true;
                        loadAssetList();
                    } else {
                        const error = await resp.json().catch(() => ({}));
                        alert(`更新失败: ${error.message || '未知错误'}`);
                    }
                } catch (err) {
                    console.error('更新资源失败', err);
                    alert('更新失败');
                }
            });

            /**
             * 导航 — 返回首页 / 登出
             */
            if (homeBtn) {
                homeBtn.addEventListener('click', () => { location.href = '/'; });
            }
            logoutBtn.addEventListener('click', () => {
                localStorage.removeItem('kax_login_token');
                location.href = '/login';
            });

            /**
             * 关闭面板
             */
            closeDetailBtn.addEventListener('click', closeDetailPanel);
            detailBackdrop.addEventListener('click', closeDetailPanel);

            /**
             * 排序和过滤事件
             */
            document.getElementById('sortSelect').addEventListener('change', () => {
                currentPage = 1;
                loadAssetList(currentPage, searchInput.value.trim());
            });

            document.getElementById('statusFilter').addEventListener('change', () => {
                currentPage = 1;
                loadAssetList(currentPage, searchInput.value.trim());
            });

            /**
             * 全局函数供 HTML 调用
             */
            window.loadToUpdateForm = loadToUpdateForm;
            window.confirmDelete = confirmDelete;

            // 验证 token
            verifyToken();
        })();
    </script>
</body>

</html>
